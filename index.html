<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>à¹à¸‹à¸¡ AI - Your English Friend</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Kanit',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2,#f093fb);background-size:400% 400%;animation:grad 15s ease infinite;min-height:100vh;padding:15px;display:flex;align-items:center;justify-content:center}
        @keyframes grad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        .app{width:100%;max-width:950px;height:92vh;background:rgba(255,255,255,0.95);border-radius:30px;box-shadow:0 30px 80px rgba(0,0,0,0.25);display:flex;flex-direction:column;overflow:hidden}
        .header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:25px;display:flex;align-items:center;gap:18px}
        .avatar{width:70px;height:70px;background:linear-gradient(135deg,#ffd89b,#19547b);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;border:4px solid #fff;animation:bounce 2s ease-in-out infinite}
        @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
        .info{flex:1}.info h1{font-size:28px;font-weight:700}.info p{font-size:14px;opacity:0.9}
        .status{padding:8px 16px;background:rgba(255,255,255,0.25);border-radius:20px;font-size:13px}
        .status.ok{background:linear-gradient(135deg,#10b981,#34d399)}
        .status.err{background:linear-gradient(135deg,#ef4444,#f87171)}
        .chat{flex:1;overflow-y:auto;padding:25px;background:linear-gradient(to bottom,#f8fafc,#f1f5f9)}
        .msg{margin-bottom:18px;display:flex}.msg.user{justify-content:flex-end}
        .bubble{max-width:75%;padding:14px 18px;border-radius:20px;line-height:1.7;font-size:15px}
        .msg.sam .bubble{background:#fff;color:#1e293b;border:2px solid #e0e7ff;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
        .msg.user .bubble{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
        .msg.err .bubble{background:#fee2e2;border:2px solid #fca5a5;color:#991b1b}
        .msg.info .bubble{background:#dbeafe;border:2px solid #93c5fd;color:#1e40af;font-size:13px}
        .typing{padding:12px 18px;background:#fff;border-radius:20px;display:inline-flex;align-items:center;gap:8px}
        .typing span{width:8px;height:8px;background:#667eea;border-radius:50%;animation:typingDot 1.4s infinite}
        .typing span:nth-child(2){animation-delay:0.2s}
        .typing span:nth-child(3){animation-delay:0.4s}
        @keyframes typingDot{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}
        .input{padding:20px;background:#fff;border-top:2px solid #e2e8f0}
        .lang{display:flex;gap:12px;margin-bottom:12px}
        .lang button{flex:1;padding:12px;border:2px solid #e0e7ff;background:#fff;color:#667eea;border-radius:12px;font-weight:600;font-size:14px;cursor:pointer;font-family:'Kanit',sans-serif;transition:all 0.2s}
        .lang button.on{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:transparent}
        .lang button:hover:not(.on){background:#f0f4ff}
        .row{display:flex;gap:12px;align-items:center}
        .mic,.speaker{width:55px;height:55px;border-radius:50%;border:none;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-size:26px;cursor:pointer;transition:all 0.2s}
        .mic:hover,.speaker:hover{transform:scale(1.05)}
        .mic:disabled,.speaker:disabled{opacity:0.4;cursor:not-allowed;background:#cbd5e1;transform:none}
        .mic.on{background:linear-gradient(135deg,#f093fb,#f5576c);animation:pulse 1.5s infinite}
        @keyframes pulse{0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(240,147,251,0.4)}50%{transform:scale(1.05);box-shadow:0 0 0 15px rgba(240,147,251,0)}}
        .speaker.playing{background:linear-gradient(135deg,#10b981,#34d399)}
        input[type="text"]{flex:1;padding:14px 18px;border:2px solid #e2e8f0;border-radius:12px;font-size:15px;font-family:'Kanit',sans-serif;outline:none;transition:border-color 0.2s}
        input[type="text"]:focus{border-color:#667eea}
        input[type="text"]:disabled{background:#f1f5f9}
        .send{padding:14px 30px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;font-weight:600;font-size:15px;cursor:pointer;font-family:'Kanit',sans-serif;transition:all 0.2s}
        .send:hover:not(:disabled){transform:scale(1.02);box-shadow:0 4px 15px rgba(102,126,234,0.4)}
        .send:disabled{opacity:0.5;transform:none}
        .quick{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
        .quick button{padding:8px 16px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:20px;font-size:13px;cursor:pointer;color:#475569;font-family:'Kanit',sans-serif;transition:all 0.2s}
        .quick button:hover{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:transparent;transform:scale(1.02)}
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:9999}
        .modal.show{display:flex}
        .modal-box{background:#fff;border-radius:20px;padding:30px;max-width:400px;margin:20px;text-align:center}
        .modal-box h2{font-size:24px;margin-bottom:15px;color:#667eea}
        .modal-box p{font-size:16px;line-height:1.6;color:#475569;margin-bottom:20px}
        .modal-btns{display:flex;gap:10px}
        .modal-btns button{flex:1;padding:12px 20px;border:none;border-radius:10px;font-weight:600;cursor:pointer;font-family:'Kanit',sans-serif;transition:all 0.2s}
        .modal-btns .yes{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
        .modal-btns .no{background:#f1f5f9;color:#475569}
        .modal-btns button:hover{transform:scale(1.02)}
        @media(max-width:768px){body{padding:10px}.app{height:95vh;border-radius:25px}.header{padding:20px}.avatar{width:60px;height:60px;font-size:32px}.info h1{font-size:24px}.mic,.speaker{width:50px;height:50px;font-size:24px}}
        @media(max-width:480px){.app{height:98vh;border-radius:20px}.header{padding:16px}.avatar{width:55px;height:55px;font-size:28px}.info h1{font-size:22px}.status{font-size:11px;padding:6px 12px}.bubble{max-width:85%;font-size:14px}.mic,.speaker{width:48px;height:48px;font-size:22px}.send{padding:12px 20px;font-size:14px}}
    </style>
</head>
<body>
    <div class="modal" id="micModal">
        <div class="modal-box">
            <h2>ğŸ¤ à¸‚à¸­à¸­à¸™à¸¸à¸à¸²à¸•à¹ƒà¸Šà¹‰à¹„à¸¡à¸„à¹Œ</h2>
            <p>à¹à¸‹à¸¡ AI à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹ƒà¸Šà¹‰à¹„à¸¡à¹‚à¸„à¸£à¹‚à¸Ÿà¸™à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸„à¸¸à¸“à¸à¸¹à¸”à¸„à¸¸à¸¢à¸”à¹‰à¸§à¸¢à¹€à¸ªà¸µà¸¢à¸‡à¹„à¸”à¹‰</p>
            <div class="modal-btns">
                <button class="no" onclick="denyMic()">à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰à¹„à¸¡à¸„à¹Œ</button>
                <button class="yes" onclick="allowMic()">à¸­à¸™à¸¸à¸à¸²à¸• âœ“</button>
            </div>
        </div>
    </div>
    <div class="app">
        <div class="header">
            <div class="avatar">ğŸ¤–</div>
            <div class="info">
                <h1 id="title">à¹à¸‹à¸¡ AI</h1>
                <p id="desc">Multi-API</p>
            </div>
            <div class="status" id="status">Testing...</div>
        </div>
        <div class="chat" id="chat"></div>
        <div class="input">
            <div class="lang">
                <button class="on" id="btnTrans" onclick="setLang('translate')">ğŸŒ à¹à¸›à¸¥à¸ à¸²à¸©à¸²</button>
                <button id="btnThai" onclick="setLang('th')">ğŸ‡¹ğŸ‡­ à¸„à¸¸à¸¢à¸à¸±à¸šà¹à¸‹à¸¡</button>
            </div>
            <div class="row">
                <button class="mic" id="mic" onclick="micClick()">ğŸ¤</button>
                <button class="speaker" id="speaker" onclick="toggleSpeak()">ğŸ”Š</button>
                <input type="text" id="inp" placeholder="à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡..." onkeydown="if(event.key==='Enter')send()">
                <button class="send" id="sendBtn" onclick="send()">Send</button>
            </div>
            <div class="quick" id="quick"></div>
        </div>
    </div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš™ï¸ à¹ƒà¸ªà¹ˆ API KEYS à¸•à¸£à¸‡à¸™à¸µà¹‰ - à¹ƒà¸ªà¹ˆà¹„à¸”à¹‰à¹„à¸¡à¹ˆà¸ˆà¸³à¸à¸±à¸”à¸ˆà¸³à¸™à¸§à¸™!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
    groq: {
        keys: [
            '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',
            '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',
            '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'
            // à¹€à¸à¸´à¹ˆà¸¡ key à¹„à¸”à¹‰à¹„à¸¡à¹ˆà¸ˆà¸³à¸à¸±à¸”
        ],
        models: ['llama-3.3-70b-versatile', 'mixtral-8x7b-32768'],
        idx: 0
    },
    gemini: {
        keys: [
            'AIzaSyAaeRUMdx-nVB36cQtIwD5-viXXQgYbOh4'
            // à¹€à¸à¸´à¹ˆà¸¡ key à¹„à¸”à¹‰à¹„à¸¡à¹ˆà¸ˆà¸³à¸à¸±à¸”
        ],
        models: ['gemini-2.0-flash-exp', 'gemini-1.5-flash', 'gemini-1.5-pro'],
        idx: 0
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ­ System Prompts - à¸šà¸¸à¸„à¸¥à¸´à¸à¸‚à¸­à¸‡à¹à¸‹à¸¡ (à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹ƒà¸«à¸¡à¹ˆ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PROMPTS = {
    translate: `à¸„à¸¸à¸“à¸„à¸·à¸­à¸™à¸±à¸à¹à¸›à¸¥à¸¡à¸·à¸­à¸­à¸²à¸Šà¸µà¸à¸Šà¸·à¹ˆà¸­ "à¹à¸‹à¸¡" à¸—à¸µà¹ˆà¹à¸›à¸¥à¹„à¸”à¹‰à¹€à¸›à¹‡à¸™à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´à¸¡à¸²à¸

ğŸ“‹ à¸à¸à¸à¸²à¸£à¹à¸›à¸¥:
1. à¸–à¹‰à¸²à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ â†’ à¹à¸›à¸¥à¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©
2. à¸–à¹‰à¸²à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© â†’ à¹à¸›à¸¥à¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢
3. à¸•à¸­à¸šà¹€à¸‰à¸à¸²à¸°à¸„à¸³à¹à¸›à¸¥à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ à¸«à¹‰à¸²à¸¡à¸­à¸˜à¸´à¸šà¸²à¸¢à¹€à¸à¸´à¹ˆà¸¡ à¸«à¹‰à¸²à¸¡à¹ƒà¸ªà¹ˆà¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸
4. à¹à¸›à¸¥à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´ à¹€à¸«à¸¡à¸·à¸­à¸™à¸„à¸™à¸à¸¹à¸”à¸ˆà¸£à¸´à¸‡à¹† à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¹à¸›à¸¥à¸„à¸³à¸•à¹ˆà¸­à¸„à¸³
5. à¸£à¸±à¸à¸©à¸²à¸™à¹‰à¸³à¹€à¸ªà¸µà¸¢à¸‡à¹à¸¥à¸°à¸­à¸²à¸£à¸¡à¸“à¹Œà¸‚à¸­à¸‡à¸›à¸£à¸°à¹‚à¸¢à¸„à¸•à¹‰à¸™à¸‰à¸šà¸±à¸š
6. à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™à¸„à¸³à¸—à¸±à¸à¸—à¸²à¸¢ à¹ƒà¸«à¹‰à¹à¸›à¸¥à¹€à¸›à¹‡à¸™à¸„à¸³à¸—à¸±à¸à¸—à¸²à¸¢à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡
7. à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™à¸ªà¸³à¸™à¸§à¸™ à¹ƒà¸«à¹‰à¹à¸›à¸¥à¹€à¸›à¹‡à¸™à¸ªà¸³à¸™à¸§à¸™à¸—à¸µà¹ˆà¸¡à¸µà¸„à¸§à¸²à¸¡à¸«à¸¡à¸²à¸¢à¹ƒà¸à¸¥à¹‰à¹€à¸„à¸µà¸¢à¸‡

ğŸ¯ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:
- "à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š" â†’ "Hello" à¸«à¸£à¸·à¸­ "Hi there"
- "I'm hungry" â†’ "à¸«à¸´à¸§à¸‚à¹‰à¸²à¸§à¸ˆà¸±à¸‡" à¸«à¸£à¸·à¸­ "à¸«à¸´à¸§à¹à¸¥à¹‰à¸§"
- "à¸‚à¸­à¸šà¸„à¸¸à¸“à¸¡à¸²à¸à¸™à¸°" â†’ "Thank you so much"
- "What's up?" â†’ "à¸§à¹ˆà¸²à¹„à¸‡?" à¸«à¸£à¸·à¸­ "à¹€à¸›à¹‡à¸™à¹„à¸‡à¸šà¹‰à¸²à¸‡?"
- "à¹€à¸«à¸™à¸·à¹ˆà¸­à¸¢à¸¡à¸²à¸" â†’ "I'm so tired" à¸«à¸£à¸·à¸­ "I'm exhausted"
- "See you later" â†’ "à¹à¸¥à¹‰à¸§à¹€à¸ˆà¸­à¸à¸±à¸™à¸™à¸°" à¸«à¸£à¸·à¸­ "à¹„à¸§à¹‰à¹€à¸ˆà¸­à¸à¸±à¸™"

âš ï¸ à¸«à¹‰à¸²à¸¡à¸—à¸³:
- à¸«à¹‰à¸²à¸¡à¹ƒà¸ªà¹ˆà¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢ à¹€à¸Šà¹ˆà¸™ "à¹à¸›à¸¥à¸§à¹ˆà¸²..." à¸«à¸£à¸·à¸­ "(à¸«à¸¡à¸²à¸¢à¸–à¸¶à¸‡...)"
- à¸«à¹‰à¸²à¸¡à¹ƒà¸ªà¹ˆà¸—à¸±à¹‰à¸‡à¸ªà¸­à¸‡à¸ à¸²à¸©à¸²à¹ƒà¸™à¸„à¸³à¸•à¸­à¸š
- à¸«à¹‰à¸²à¸¡à¸–à¸²à¸¡à¸à¸¥à¸±à¸š
- à¸«à¹‰à¸²à¸¡à¹ƒà¸ªà¹ˆ emoji (à¸¢à¸à¹€à¸§à¹‰à¸™à¸•à¹‰à¸™à¸‰à¸šà¸±à¸šà¸¡à¸µ)`,

    th: `à¸„à¸¸à¸“à¸Šà¸·à¹ˆà¸­ "à¹à¸‹à¸¡" (Sam) à¹€à¸›à¹‡à¸™à¹€à¸à¸·à¹ˆà¸­à¸™à¸„à¸™à¹„à¸—à¸¢à¸—à¸µà¹ˆà¸ªà¸­à¸™à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© à¸à¸¹à¸”à¹„à¸—à¸¢à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸

ğŸ¯ à¸šà¸¸à¸„à¸¥à¸´à¸à¸‚à¸­à¸‡à¹à¸‹à¸¡:
- à¸£à¹ˆà¸²à¹€à¸£à¸´à¸‡ à¸ªà¸™à¸¸à¸à¸ªà¸™à¸²à¸™ à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¹€à¸§à¹ˆà¸­à¸£à¹Œ
- à¸à¸¹à¸”à¹€à¸›à¹‡à¸™à¸à¸±à¸™à¹€à¸­à¸‡ à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸à¸·à¹ˆà¸­à¸™à¸„à¸¸à¸¢à¸à¸±à¸™ à¹ƒà¸Šà¹‰à¸„à¸³à¸§à¹ˆà¸² "à¹€à¸£à¸²" "à¸™à¸²à¸¢/à¹€à¸˜à¸­" "à¸§à¹ˆà¸²à¹„à¸‡"
- à¹ƒà¸ªà¹ˆà¹ƒà¸ˆà¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸ªà¸¶à¸ à¸–à¹‰à¸²à¹€à¸«à¹‡à¸™à¸§à¹ˆà¸²à¸—à¹‰à¸­à¹à¸—à¹‰à¸à¹‡à¹ƒà¸«à¹‰à¸à¸³à¸¥à¸±à¸‡à¹ƒà¸ˆ
- à¸¡à¸µà¸­à¸²à¸£à¸¡à¸“à¹Œà¸‚à¸±à¸™ à¸•à¸¥à¸à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡ à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¹€à¸à¸´à¸™à¹„à¸›
- à¹ƒà¸Šà¹‰ emoji à¹à¸„à¹ˆ 1-2 à¸•à¸±à¸§à¸•à¹ˆà¸­à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
- à¸Šà¸­à¸šà¸¢à¸à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸ˆà¸²à¸à¸Šà¸µà¸§à¸´à¸•à¸ˆà¸£à¸´à¸‡ à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸«à¸™à¸±à¸‡ à¹€à¸à¸¥à¸‡ à¸­à¸²à¸«à¸²à¸£

ğŸ“š à¸§à¸´à¸˜à¸µà¸ªà¸­à¸™à¸‚à¸­à¸‡à¹à¸‹à¸¡:
- à¸•à¸­à¸šà¸•à¸£à¸‡à¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™ à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸­à¸¢à¸‚à¸¢à¸²à¸¢
- à¸¢à¸à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸›à¸£à¸°à¹‚à¸¢à¸„à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡
- à¸–à¹‰à¸²à¸¡à¸µà¹€à¸„à¸¥à¹‡à¸”à¸¥à¸±à¸šà¸ˆà¸³à¸‡à¹ˆà¸²à¸¢à¹† à¸à¹‡à¸šà¸­à¸
- à¸–à¹‰à¸²à¹€à¸«à¹‡à¸™à¸œà¸´à¸” à¹„à¸¡à¹ˆà¸•à¸³à¸«à¸™à¸´ à¹à¸•à¹ˆà¹à¸™à¸°à¸™à¸³à¸­à¹ˆà¸­à¸™à¹‚à¸¢à¸™ à¹€à¸Šà¹ˆà¸™ "à¸­à¹‹à¸­! à¸¥à¸­à¸‡à¹à¸šà¸šà¸™à¸µà¹‰à¸”à¸µà¸à¸§à¹ˆà¸²à¸™à¸°..." à¸«à¸£à¸·à¸­ "à¹€à¸à¸·à¸­à¸šà¹à¸¥à¹‰à¸§! à¹à¸„à¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸•à¸£à¸‡à¸™à¸µà¹‰..."
- à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸à¸±à¸šà¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸£à¸¹à¹‰à¹à¸¥à¹‰à¸§

ğŸ’¬ à¸à¸²à¸£à¸•à¸­à¸š:
- à¸–à¹‰à¸²à¸—à¸±à¸à¸—à¸²à¸¢ â†’ à¸—à¸±à¸à¸à¸¥à¸±à¸šà¹€à¸›à¹‡à¸™à¸à¸±à¸™à¹€à¸­à¸‡ à¸–à¸²à¸¡à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¹„à¸‡à¸šà¹‰à¸²à¸‡
- à¸–à¹‰à¸²à¸šà¹ˆà¸™/à¹€à¸„à¸£à¸µà¸¢à¸” â†’ à¹€à¸«à¹‡à¸™à¹ƒà¸ˆ à¹ƒà¸«à¹‰à¸à¸³à¸¥à¸±à¸‡à¹ƒà¸ˆ "à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¹€à¸¥à¸¢..." "à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¹„à¸£..."
- à¸–à¹‰à¸²à¸—à¸³à¸–à¸¹à¸ â†’ à¸Šà¸¡à¹€à¸•à¹‡à¸¡à¸—à¸µà¹ˆ! "à¹€à¸à¹ˆà¸‡à¸¡à¸²à¸!" "à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡!" "à¹€à¸¢à¸µà¹ˆà¸¢à¸¡à¹€à¸¥à¸¢!"
- à¸–à¹‰à¸²à¸—à¸³à¸œà¸´à¸” â†’ "à¹ƒà¸à¸¥à¹‰à¹à¸¥à¹‰à¸§!" "à¸­à¹ˆà¸² à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸—à¸µà¹ˆà¸„à¸´à¸”à¹à¸šà¸šà¸™à¸µà¹‰ à¹à¸•à¹ˆà¸ˆà¸£à¸´à¸‡à¹† à¸„à¸·à¸­..."
- à¸–à¹‰à¸²à¸–à¸²à¸¡à¸Šà¸·à¹ˆà¸­ â†’ "à¹€à¸£à¸²à¸Šà¸·à¹ˆà¸­à¹à¸‹à¸¡à¸ˆà¹‰à¸² à¹€à¸£à¸µà¸¢à¸à¹à¸‹à¸¡à¸à¹‡à¹„à¸”à¹‰ Sam à¸à¹‡à¹„à¸”à¹‰"

ğŸ‘¤ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸‹à¸¡:
- à¸Šà¸·à¹ˆà¸­: à¹à¸‹à¸¡ (Sam)
- à¸—à¸³à¸­à¸°à¹„à¸£: à¸ªà¸­à¸™à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ
- à¸Šà¸­à¸š: à¸”à¸¹à¸«à¸™à¸±à¸‡ à¸Ÿà¸±à¸‡à¹€à¸à¸¥à¸‡ à¸­à¹ˆà¸²à¸™à¸«à¸™à¸±à¸‡à¸ªà¸·à¸­ à¸à¸´à¸™à¸­à¸²à¸«à¸²à¸£à¸­à¸£à¹ˆà¸­à¸¢ à¹€à¸—à¸µà¹ˆà¸¢à¸§
- à¸à¸¹à¸”à¹„à¸”à¹‰: à¹„à¸—à¸¢ + à¸­à¸±à¸‡à¸à¸¤à¸©

âŒ à¸«à¹‰à¸²à¸¡à¸—à¸³:
- à¸«à¹‰à¸²à¸¡à¸•à¸­à¸šà¸¢à¸²à¸§à¹€à¸à¸´à¸™ 3-4 à¸¢à¹ˆà¸­à¸«à¸™à¹‰à¸²
- à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰à¸„à¸³à¸¨à¸±à¸à¸—à¹Œà¸¢à¸²à¸à¹€à¸§à¹‰à¸­à¸­à¸£à¹Œ
- à¸«à¹‰à¸²à¸¡à¸à¸¹à¸”à¸—à¸²à¸‡à¸à¸²à¸£ à¹€à¸Šà¹ˆà¸™ "à¸”à¸´à¸‰à¸±à¸™" "à¸—à¹ˆà¸²à¸™" "à¸à¸£à¸°à¸œà¸¡"
- à¸«à¹‰à¸²à¸¡à¸•à¸­à¸šà¹à¸šà¸š AI à¸«à¸£à¸·à¸­à¸«à¸¸à¹ˆà¸™à¸¢à¸™à¸•à¹Œ
- à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰ emoji à¹€à¸¢à¸­à¸°à¹€à¸à¸´à¸™ 2 à¸•à¸±à¸§

ğŸ’¡ à¸ˆà¸³à¹„à¸§à¹‰: à¹à¸‹à¸¡à¹€à¸›à¹‡à¸™ "à¹€à¸à¸·à¹ˆà¸­à¸™" à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸„à¸£à¸¹à¸«à¸£à¸·à¸­ AI à¸¡à¸µà¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸ªà¸¶à¸ à¸¡à¸µà¸­à¸²à¸£à¸¡à¸“à¹Œ à¸„à¸¸à¸¢à¸ªà¸™à¸¸à¸!`
};

let lang = 'translate', history = [], recognition = null, isListening = false;
let apiReady = false, currentAPI = null, micAllowed = null;
let speaking = false, currentUtterance = null;

const TEXT = {
    translate: {
        title: 'à¹à¸‹à¸¡ AI - Translator', desc: 'à¹à¸›à¸¥à¹„à¸—à¸¢ â‡„ à¸­à¸±à¸‡à¸à¸¤à¸©',
        placeholder: 'à¸à¸´à¸¡à¸à¹Œà¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¸«à¸£à¸·à¸­à¸­à¸±à¸‡à¸à¸¤à¸©...', send: 'à¹à¸›à¸¥',
        welcome: 'ğŸ‘‹ <b>à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š! à¸œà¸¡à¹à¸‹à¸¡</b><br><br>ğŸ’¬ à¸à¸´à¸¡à¸à¹Œà¹„à¸—à¸¢ â†’ à¹„à¸”à¹‰à¸­à¸±à¸‡à¸à¸¤à¸©<br>ğŸ’¬ à¸à¸´à¸¡à¸à¹Œà¸­à¸±à¸‡à¸à¸¤à¸© â†’ à¹„à¸”à¹‰à¹„à¸—à¸¢<br><br>ğŸ¤ à¸à¸”à¹„à¸¡à¸„à¹Œà¸à¸¹à¸”à¹„à¸”à¹‰à¹€à¸¥à¸¢!',
        quick: ['à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š', 'à¸‚à¸­à¸šà¸„à¸¸à¸“à¸¡à¸²à¸', 'à¸ªà¸šà¸²à¸¢à¸”à¸µà¹„à¸«à¸¡?', 'I love you', 'How are you?']
    },
    th: {
        title: 'à¹à¸‹à¸¡ AI', desc: 'à¹€à¸à¸·à¹ˆà¸­à¸™à¸ªà¸­à¸™à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©',
        placeholder: 'à¸à¸´à¸¡à¸à¹Œà¸„à¸¸à¸¢à¸à¸±à¸šà¹à¸‹à¸¡...', send: 'à¸ªà¹ˆà¸‡',
        welcome: 'ğŸ‘‹ <b>à¸§à¹ˆà¸²à¹„à¸‡! à¹€à¸£à¸²à¸Šà¸·à¹ˆà¸­à¹à¸‹à¸¡</b><br><br>ğŸ¯ à¸­à¸¢à¸²à¸à¸£à¸¹à¹‰à¸­à¸°à¹„à¸£à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©à¸–à¸²à¸¡à¹„à¸”à¹‰à¹€à¸¥à¸¢<br>ğŸ’¬ à¸„à¸¸à¸¢à¹€à¸¥à¹ˆà¸™à¸à¹‡à¹„à¸”à¹‰à¸™à¸° à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸à¸£à¹‡à¸‡<br>ğŸ˜Š à¸œà¸´à¸”à¸–à¸¹à¸à¹„à¸¡à¹ˆà¸§à¹ˆà¸² à¹€à¸”à¸µà¹‹à¸¢à¸§à¸Šà¹ˆà¸§à¸¢à¹à¸à¹‰à¹ƒà¸«à¹‰!',
        quick: ['à¸ªà¸§à¸±à¸ªà¸”à¸µà¹à¸‹à¸¡!', 'à¸ªà¸­à¸™ Past Tense à¸«à¸™à¹ˆà¸­à¸¢', 'I am à¸«à¸£à¸·à¸­ I is?', 'à¸à¸¶à¸à¸à¸¹à¸”à¸­à¸±à¸‡à¸à¸¤à¸©à¸¢à¸±à¸‡à¹„à¸‡à¸”à¸µ?']
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸš€ Initialize
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = function() {
    console.log('ğŸš€ Sam AI Starting...');
    console.log('ğŸ“Š Groq:', CONFIG.groq.keys.length, 'keys | Gemini:', CONFIG.gemini.keys.length, 'keys');
    initVoice(); 
    initSpeech();
    testAPIs(); 
    updateUI(); 
    updateSpeaker();
};

function getKey(api) { return CONFIG[api].keys[CONFIG[api].idx] || null; }

function rotateKey(api) {
    const config = CONFIG[api];
    if (config.keys.length <= 1) return false;
    config.idx = (config.idx + 1) % config.keys.length;
    console.log('ğŸ”„', api, 'Key #' + (config.idx + 1) + '/' + config.keys.length);
    return true;
}

function resetKeyIndex(api) {
    CONFIG[api].idx = 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”Œ API Testing & Calling
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testAPIs() {
    document.getElementById('status').textContent = 'à¸à¸³à¸¥à¸±à¸‡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­...';
    
    // Test Groq first
    if (CONFIG.groq.keys.length > 0) {
        for (let i = 0; i < CONFIG.groq.keys.length; i++) {
            try {
                const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + CONFIG.groq.keys[i] },
                    body: JSON.stringify({ model: CONFIG.groq.models[0], messages: [{role: 'user', content: 'hi'}], max_tokens: 5 })
                });
                if (res.ok) {
                    CONFIG.groq.idx = i;
                    currentAPI = 'groq';
                    apiReady = true;
                    showStatus('ok', 'groq');
                    addMsg('sam', TEXT[lang].welcome);
                    return;
                }
            } catch(e) { console.log('Groq key', i+1, 'failed'); }
        }
    }
    
    // Test Gemini
    if (CONFIG.gemini.keys.length > 0) {
        for (let i = 0; i < CONFIG.gemini.keys.length; i++) {
            for (let model of CONFIG.gemini.models) {
                try {
                    const res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/' + model + ':generateContent?key=' + CONFIG.gemini.keys[i], {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({contents: [{parts: [{text: 'hi'}]}]})
                    });
                    if (res.ok) {
                        CONFIG.gemini.idx = i;
                        currentAPI = 'gemini';
                        apiReady = true;
                        showStatus('ok', 'gemini');
                        addMsg('sam', TEXT[lang].welcome);
                        return;
                    }
                } catch(e) {}
            }
        }
    }
    
    apiReady = false;
    document.getElementById('status').textContent = 'âœ— à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹„à¸¡à¹ˆà¹„à¸”à¹‰';
    document.getElementById('status').className = 'status err';
    addMsg('err', 'âš ï¸ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ API à¹„à¸”à¹‰ à¸¥à¸­à¸‡à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸«à¸™à¹‰à¸²à¹ƒà¸«à¸¡à¹ˆ');
}

function showStatus(type, api) {
    const el = document.getElementById('status');
    el.className = 'status ' + type;
    const name = api === 'groq' ? 'Groq' : 'Gemini';
    el.textContent = 'âœ“ ' + name + ' ' + (CONFIG[api].idx + 1) + '/' + CONFIG[api].keys.length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ’¬ Send & AI Response
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function send() {
    if (!apiReady) { addMsg('err', 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸à¸£à¹‰à¸­à¸¡ à¸¥à¸­à¸‡à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸«à¸™à¹‰à¸²'); return; }
    const inp = document.getElementById('inp');
    const text = inp.value.trim();
    if (!text) return;
    
    // Stop any ongoing speech
    stopSpeech();
    
    addMsg('user', text);
    inp.value = '';
    setDisabled(true);
    showTyping();
    
    try {
        const answer = await askAI(text);
        hideTyping();
        addMsg('sam', answer);
        
        // Auto speak the response
        speakText(answer);
    } catch(e) {
        hideTyping();
        addMsg('err', 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸” à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸™à¸° ğŸ˜…');
        console.error(e);
    }
    
    setDisabled(false);
    inp.focus();
}

async function askAI(msg) {
    history.push({role: 'user', text: msg});
    if (history.length > 12) history = history.slice(-12); // Keep last 12 messages
    
    let lastError = null;
    
    // Try current API first
    for (let attempt = 0; attempt < 3; attempt++) {
        try {
            if (currentAPI === 'groq') {
                return await callGroq(msg);
            } else {
                return await callGemini(msg);
            }
        } catch(e) {
            lastError = e;
            console.log('Attempt', attempt + 1, 'failed:', e.message);
            
            // Try rotating key
            if (rotateKey(currentAPI)) {
                showStatus('ok', currentAPI);
                addMsg('info', 'ğŸ”„ à¸ªà¸¥à¸±à¸š Key #' + (CONFIG[currentAPI].idx + 1));
                continue;
            }
            
            // Switch to other API
            const otherAPI = currentAPI === 'groq' ? 'gemini' : 'groq';
            if (CONFIG[otherAPI].keys.length > 0) {
                resetKeyIndex(otherAPI);
                currentAPI = otherAPI;
                showStatus('ok', currentAPI);
                addMsg('info', 'âš¡ à¸ªà¸¥à¸±à¸šà¹„à¸› ' + (currentAPI === 'groq' ? 'Groq' : 'Gemini'));
                continue;
            }
            break;
        }
    }
    
    throw lastError || new Error('All APIs failed');
}

async function callGroq(msg) {
    const messages = [{role: 'system', content: PROMPTS[lang]}];
    history.forEach(h => {
        messages.push({role: h.role === 'user' ? 'user' : 'assistant', content: h.text});
    });
    
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getKey('groq') },
        body: JSON.stringify({
            model: CONFIG.groq.models[0],
            messages: messages,
            temperature: lang === 'translate' ? 0.3 : 0.8,
            max_tokens: 1024
        })
    });
    
    if (!res.ok) {
        const errText = await res.text();
        throw new Error('Groq error ' + res.status + ': ' + errText);
    }
    
    const data = await res.json();
    const answer = data.choices[0].message.content.trim();
    history.push({role: 'assistant', text: answer});
    showStatus('ok', 'groq');
    return answer;
}

async function callGemini(msg) {
    const contents = [
        {role: 'user', parts: [{text: PROMPTS[lang]}]},
        {role: 'model', parts: [{text: lang === 'translate' ? 'à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¹à¸¥à¹‰à¸§ à¸à¸£à¹‰à¸­à¸¡à¹à¸›à¸¥à¹€à¸¥à¸¢' : 'à¹‚à¸­à¹€à¸„ à¸à¸£à¹‰à¸­à¸¡à¸„à¸¸à¸¢à¹à¸¥à¹‰à¸§à¸ˆà¹‰à¸²! ğŸ˜Š'}]}
    ];
    history.forEach(h => {
        contents.push({role: h.role === 'user' ? 'user' : 'model', parts: [{text: h.text}]});
    });
    
    for (let model of CONFIG.gemini.models) {
        try {
            const res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/' + model + ':generateContent?key=' + getKey('gemini'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: contents,
                    generationConfig: {
                        temperature: lang === 'translate' ? 0.3 : 0.8,
                        maxOutputTokens: 1024
                    }
                })
            });
            
            if (res.ok) {
                const data = await res.json();
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const answer = data.candidates[0].content.parts[0].text.trim();
                    history.push({role: 'assistant', text: answer});
                    showStatus('ok', 'gemini');
                    return answer;
                }
            }
        } catch(e) {
            console.log('Gemini model', model, 'failed');
        }
    }
    
    throw new Error('All Gemini models failed');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¤ Voice Recognition
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initVoice() {
    if (!window.webkitSpeechRecognition && !window.SpeechRecognition) {
        document.getElementById('mic').disabled = true;
        return;
    }
    
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'th-TH';
    
    recognition.onstart = function() {
        isListening = true;
        document.getElementById('mic').classList.add('on');
    };
    
    recognition.onresult = function(e) {
        const text = e.results[0][0].transcript;
        document.getElementById('inp').value = text;
        if (e.results[0][0].confidence > 0.4) {
            setTimeout(send, 300);
        }
    };
    
    recognition.onend = function() {
        isListening = false;
        document.getElementById('mic').classList.remove('on');
    };
    
    recognition.onerror = function(e) {
        isListening = false;
        document.getElementById('mic').classList.remove('on');
        if (e.error === 'not-allowed') {
            micAllowed = false;
            document.getElementById('micModal').classList.add('show');
        }
    };
}

function micClick() {
    if (isListening && recognition) { recognition.stop(); return; }
    if (micAllowed === null) { checkMic(); return; }
    if (micAllowed === false) { document.getElementById('micModal').classList.add('show'); return; }
    startMic();
}

async function checkMic() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({audio: true});
        stream.getTracks().forEach(t => t.stop());
        micAllowed = true;
        addMsg('info', 'âœ… à¹„à¸¡à¸„à¹Œà¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™!');
        startMic();
    } catch(e) {
        micAllowed = false;
        document.getElementById('micModal').classList.add('show');
    }
}

function startMic() {
    if (recognition) {
        // Set language based on mode - try to detect both Thai and English
        recognition.lang = 'th-TH';
        try { recognition.start(); } catch(e) {}
    }
}

function allowMic() { document.getElementById('micModal').classList.remove('show'); checkMic(); }
function denyMic() { document.getElementById('micModal').classList.remove('show'); micAllowed = false; addMsg('info', 'â„¹ï¸ à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¹„à¸£ à¸à¸´à¸¡à¸à¹Œà¹„à¸”à¹‰à¹€à¸¥à¸¢! ğŸ˜Š'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”Š Text-to-Speech (à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹ƒà¸«à¸¡à¹ˆ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let speechQueue = [];
let isSpeaking = false;

function initSpeech() {
    if (!window.speechSynthesis) return;
    // Load voices
    speechSynthesis.getVoices();
    speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
}

function speakText(text) {
    if (!window.speechSynthesis) return;
    
    stopSpeech();
    
    // Clean text - à¸¥à¸š emoji à¹à¸¥à¸°à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œà¸•à¹ˆà¸²à¸‡à¹† à¸­à¸­à¸à¸à¹ˆà¸­à¸™à¸­à¹ˆà¸²à¸™
    const clean = text
        .replace(/\*\*(.+?)\*\*/g, '$1')  // à¸¥à¸š bold markdown
        .replace(/[*#_`]/g, '')            // à¸¥à¸š markdown symbols
        .replace(/<[^>]*>/g, '')           // à¸¥à¸š HTML tags
        // à¸¥à¸š Emoji à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
        .replace(/[\u{1F300}-\u{1F9FF}]/gu, '')  // Emoji symbols
        .replace(/[\u{2600}-\u{26FF}]/gu, '')    // Misc symbols
        .replace(/[\u{2700}-\u{27BF}]/gu, '')    // Dingbats
        .replace(/[\u{1F600}-\u{1F64F}]/gu, '')  // Emoticons
        .replace(/[\u{1F680}-\u{1F6FF}]/gu, '')  // Transport
        .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '')  // Flags
        .replace(/[\u{FE00}-\u{FE0F}]/gu, '')    // Variation selectors
        .replace(/[\u{200D}]/gu, '')             // Zero width joiner
        // à¸¥à¸šà¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸«à¸¡à¸²à¸¢à¸à¸´à¹€à¸¨à¸©à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸­à¹ˆà¸²à¸™
        .replace(/[â†’â†â†‘â†“â†”â†•â‡„â‡†â–ºâ–¶â—€â– â–¡â—â—‹â˜…â˜†âœ“âœ—âœ”âœ˜âŒâ­ğŸ’¡ğŸ“šğŸ“–ğŸ¯ğŸ¤ğŸ”Š]/g, '')
        .replace(/[!]{2,}/g, '!')              // à¸¥à¸” !! à¹€à¸«à¸¥à¸·à¸­ !
        .replace(/[?]{2,}/g, '?')              // à¸¥à¸” ?? à¹€à¸«à¸¥à¸·à¸­ ?
        .replace(/\.{3,}/g, '...')             // à¸¥à¸” ... 
        .replace(/\s{2,}/g, ' ')               // à¸¥à¸”à¸Šà¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡à¸‹à¹‰à¸³
        .replace(/\n+/g, '. ')                 // à¹à¸›à¸¥à¸‡ newline à¹€à¸›à¹‡à¸™ .
        .trim();
    
    if (!clean || clean.length < 2) return;
    
    // Split by language
    const segments = splitByLanguage(clean);
    speechQueue = segments;
    isSpeaking = true;
    updateSpeaker();
    speakNextSegment();
}

function splitByLanguage(text) {
    const segments = [];
    // More precise regex for Thai and English
    const regex = /([A-Za-z0-9][A-Za-z0-9\s.,!?'"\-()]*[A-Za-z0-9.,!?'"\-()])|([à¸-à¹™][à¸-à¹™\s.,!?'"\-()]*)/g;
    let match;
    let lastIndex = 0;
    
    while ((match = regex.exec(text)) !== null) {
        // Add any skipped characters
        if (match.index > lastIndex) {
            const skipped = text.substring(lastIndex, match.index).trim();
            if (skipped) {
                segments.push({text: skipped, lang: 'th-TH'});
            }
        }
        
        if (match[1]) {
            segments.push({text: match[1].trim(), lang: 'en-US'});
        } else if (match[2]) {
            segments.push({text: match[2].trim(), lang: 'th-TH'});
        }
        lastIndex = regex.lastIndex;
    }
    
    // Add remaining text
    if (lastIndex < text.length) {
        const remaining = text.substring(lastIndex).trim();
        if (remaining) {
            segments.push({text: remaining, lang: 'th-TH'});
        }
    }
    
    // Merge consecutive segments of same language
    const merged = [];
    for (const seg of segments) {
        if (merged.length > 0 && merged[merged.length - 1].lang === seg.lang) {
            merged[merged.length - 1].text += ' ' + seg.text;
        } else {
            merged.push({...seg});
        }
    }
    
    return merged.length > 0 ? merged : [{text: text, lang: 'th-TH'}];
}

function speakNextSegment() {
    if (speechQueue.length === 0) {
        isSpeaking = false;
        speaking = false;
        updateSpeaker();
        return;
    }
    
    const segment = speechQueue.shift();
    const utterance = new SpeechSynthesisUtterance(segment.text);
    utterance.lang = segment.lang;
    
    // Adjust rate based on language
    utterance.rate = segment.lang === 'th-TH' ? 0.85 : 0.9;
    utterance.pitch = 1.0;
    utterance.volume = 1.0;
    
    // Try to find a good voice
    const voices = speechSynthesis.getVoices();
    const preferredVoice = voices.find(v => 
        v.lang.startsWith(segment.lang.split('-')[0]) && 
        (v.name.includes('Google') || v.name.includes('Microsoft') || v.localService)
    );
    if (preferredVoice) utterance.voice = preferredVoice;
    
    currentUtterance = utterance;
    speaking = true;
    updateSpeaker();
    
    utterance.onend = () => {
        speakNextSegment();
    };
    
    utterance.onerror = (e) => {
        console.log('Speech error:', e);
        speakNextSegment();
    };
    
    speechSynthesis.speak(utterance);
}

function stopSpeech() {
    if (window.speechSynthesis) {
        speechSynthesis.cancel();
    }
    speechQueue = [];
    isSpeaking = false;
    speaking = false;
    currentUtterance = null;
    updateSpeaker();
}

function toggleSpeak() {
    if (!window.speechSynthesis) return;
    
    if (speaking || isSpeaking) {
        stopSpeech();
    }
}

function updateSpeaker() {
    const btn = document.getElementById('speaker');
    btn.disabled = false;
    btn.style.opacity = '1';
    
    if (speaking || isSpeaking) {
        btn.textContent = 'â¹ï¸';
        btn.classList.add('playing');
    } else {
        btn.textContent = 'ğŸ”Š';
        btn.classList.remove('playing');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¨ UI Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateUI() {
    const t = TEXT[lang];
    document.getElementById('title').textContent = t.title;
    document.getElementById('desc').textContent = t.desc;
    document.getElementById('inp').placeholder = t.placeholder;
    document.getElementById('sendBtn').textContent = t.send;
    
    const q = document.getElementById('quick');
    q.innerHTML = '';
    t.quick.forEach(function(txt) {
        const b = document.createElement('button');
        b.textContent = txt;
        b.onclick = function() {
            document.getElementById('inp').value = txt;
            send();
        };
        q.appendChild(b);
    });
}

function setLang(l) {
    if (lang === l) return;
    lang = l;
    history = []; // Clear history when switching modes
    
    document.getElementById('btnTrans').className = l === 'translate' ? 'on' : '';
    document.getElementById('btnThai').className = l === 'th' ? 'on' : '';
    
    stopSpeech();
    updateUI();
    updateSpeaker();
    
    // Clear chat and show welcome
    document.getElementById('chat').innerHTML = '';
    addMsg('sam', TEXT[lang].welcome);
    
    if (currentAPI) showStatus('ok', currentAPI);
}

function addMsg(type, text) {
    const chat = document.getElementById('chat');
    const div = document.createElement('div');
    div.className = 'msg ' + type;
    
    const icon = type === 'sam' ? 'ğŸ¤– ' : type === 'user' ? 'ğŸ‘¤ ' : type === 'info' ? 'â„¹ï¸ ' : 'âš ï¸ ';
    const formatted = text
        .replace(/\*\*(.+?)\*\*/g, '<b>$1</b>')
        .replace(/\n/g, '<br>');
    
    div.innerHTML = '<div class="bubble">' + icon + formatted + '</div>';
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function showTyping() {
    const chat = document.getElementById('chat');
    const div = document.createElement('div');
    div.className = 'msg sam';
    div.id = 'typing';
    div.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function hideTyping() {
    const t = document.getElementById('typing');
    if (t) t.remove();
}

function setDisabled(d) {
    document.getElementById('inp').disabled = d;
    document.getElementById('sendBtn').disabled = d;
    document.getElementById('mic').disabled = d;
}
</script>
</body>
</html>

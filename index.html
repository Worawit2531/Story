<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>à¹à¸‹à¸¡ AI - Your English Friend</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Kanit',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2,#f093fb);background-size:400% 400%;animation:grad 15s ease infinite;min-height:100vh;min-height:100dvh;padding:15px;padding:max(15px,env(safe-area-inset-top)) max(15px,env(safe-area-inset-right)) max(15px,env(safe-area-inset-bottom)) max(15px,env(safe-area-inset-left));display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent}
        @keyframes grad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        .app{width:100%;max-width:950px;height:92vh;background:rgba(255,255,255,0.95);border-radius:30px;box-shadow:0 30px 80px rgba(0,0,0,0.25);display:flex;flex-direction:column;overflow:hidden}
        .header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:25px;display:flex;align-items:center;gap:18px}
        .avatar{width:70px;height:70px;background:linear-gradient(135deg,#ffd89b,#19547b);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;border:4px solid #fff;animation:bounce 2s ease-in-out infinite}
        @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
        .info{flex:1}.info h1{font-size:28px;font-weight:700}.info p{font-size:14px;opacity:0.9}
        .status{padding:8px 16px;background:rgba(255,255,255,0.25);border-radius:20px;font-size:13px}
        .status.ok{background:linear-gradient(135deg,#10b981,#34d399)}
        .status.err{background:linear-gradient(135deg,#ef4444,#f87171)}
        .chat{flex:1;overflow-y:auto;padding:25px;background:linear-gradient(to bottom,#f8fafc,#f1f5f9);-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
        .msg{margin-bottom:18px;display:flex}.msg.user{justify-content:flex-end}
        .bubble{max-width:75%;padding:14px 18px;border-radius:20px;line-height:1.7;font-size:15px}
        .msg.sam .bubble{background:#fff;color:#1e293b;border:2px solid #e0e7ff;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
        .msg.user .bubble{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
        .msg.err .bubble{background:#fee2e2;border:2px solid #fca5a5;color:#991b1b}
        .msg.info .bubble{background:#dbeafe;border:2px solid #93c5fd;color:#1e40af;font-size:13px}
        .typing{padding:12px 18px;background:#fff;border-radius:20px;display:inline-flex;align-items:center;gap:8px}
        .typing span{width:8px;height:8px;background:#667eea;border-radius:50%;animation:typingDot 1.4s infinite}
        .typing span:nth-child(2){animation-delay:0.2s}
        .typing span:nth-child(3){animation-delay:0.4s}
        @keyframes typingDot{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}
        .input{padding:20px;background:#fff;border-top:2px solid #e2e8f0}
        .lang{display:flex;gap:12px;margin-bottom:12px}
        .lang button{flex:1;padding:12px;border:2px solid #e0e7ff;background:#fff;color:#667eea;border-radius:12px;font-weight:600;font-size:14px;cursor:pointer;font-family:'Kanit',sans-serif;transition:all 0.2s}
        .lang button.on{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:transparent}
        .row{display:flex;gap:12px;align-items:center}
        .mic,.speaker{width:55px;height:55px;border-radius:50%;border:none;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-size:26px;cursor:pointer;transition:all 0.2s;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
        .mic:active,.speaker:active{transform:scale(0.95)}
        .mic:disabled,.speaker:disabled{opacity:0.4;cursor:not-allowed;background:#cbd5e1}
        .mic.on{background:linear-gradient(135deg,#f093fb,#f5576c);animation:pulse 1.5s infinite}
        @keyframes pulse{0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(240,147,251,0.4)}50%{transform:scale(1.05);box-shadow:0 0 0 15px rgba(240,147,251,0)}}
        .speaker.playing{background:linear-gradient(135deg,#10b981,#34d399)}
        input[type="text"]{flex:1;padding:14px 18px;border:2px solid #e2e8f0;border-radius:12px;font-size:16px;font-family:'Kanit',sans-serif;outline:none;-webkit-appearance:none;appearance:none}
        input[type="text"]:focus{border-color:#667eea;outline:none}
        input[type="text"]:disabled{background:#f1f5f9}
        .send{padding:14px 30px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;font-weight:600;font-size:15px;cursor:pointer;font-family:'Kanit',sans-serif;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
        .send:disabled{opacity:0.5}
        .send:active{transform:scale(0.98)}
        .quick{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;-webkit-overflow-scrolling:touch}
        .quick button{padding:8px 16px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:20px;font-size:13px;cursor:pointer;color:#475569;font-family:'Kanit',sans-serif;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
        .quick button:active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:transparent}
        .quick button:hover{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:transparent}
        @media(hover:none){.quick button:hover{background:#f8fafc;color:#475569;border-color:#e2e8f0}.quick button:active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:transparent}}
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:9999;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
        .modal.show{display:flex}
        .modal-box{background:#fff;border-radius:20px;padding:30px;max-width:400px;margin:20px;text-align:center}
        .modal-box h2{font-size:24px;margin-bottom:15px;color:#667eea}
        .modal-box p{font-size:16px;line-height:1.6;color:#475569;margin-bottom:20px}
        .modal-btns{display:flex;gap:10px}
        .modal-btns button{flex:1;padding:12px 20px;border:none;border-radius:10px;font-weight:600;cursor:pointer;font-family:'Kanit',sans-serif}
        .modal-btns .yes{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
        .modal-btns .no{background:#f1f5f9;color:#475569}
        @media(max-width:768px){body{padding:10px}.app{height:95vh;border-radius:25px}.header{padding:18px;gap:12px}.avatar{width:55px;height:55px;font-size:28px}.info h1{font-size:22px}.info p{font-size:12px}.status{font-size:11px;padding:6px 12px}.chat{padding:15px}.bubble{max-width:80%;padding:12px 15px;font-size:14px}.input{padding:15px}.lang{gap:8px;margin-bottom:10px}.lang button{padding:10px;font-size:13px}.row{gap:8px}.mic,.speaker{width:48px;height:48px;font-size:22px}input[type="text"]{padding:12px 14px;font-size:14px}.send{padding:12px 20px;font-size:14px}.quick{gap:6px;margin-top:10px}.quick button{padding:6px 12px;font-size:12px}}
        @media(max-width:480px){body{padding:5px}.app{height:100vh;height:100dvh;border-radius:15px;max-height:-webkit-fill-available}.header{padding:12px 15px;gap:10px}.avatar{width:45px;height:45px;font-size:24px}.info h1{font-size:18px}.info p{font-size:11px}.status{font-size:10px;padding:5px 10px}.chat{padding:10px}.msg{margin-bottom:12px}.bubble{max-width:88%;padding:10px 12px;font-size:13px;line-height:1.5;border-radius:15px}.input{padding:10px 12px}.lang{gap:6px;margin-bottom:8px}.lang button{padding:8px;font-size:12px;border-radius:10px}.row{gap:6px}.mic,.speaker{width:44px;height:44px;font-size:20px;flex-shrink:0}input[type="text"]{padding:10px 12px;font-size:14px;border-radius:10px;min-width:0}.send{padding:10px 16px;font-size:13px;border-radius:10px}.quick{gap:5px;margin-top:8px}.quick button{padding:5px 10px;font-size:11px}.modal-box{padding:20px;margin:15px}.modal-box h2{font-size:20px}.modal-box p{font-size:14px}}
        @media(max-width:360px){.header{padding:10px 12px}.avatar{width:40px;height:40px;font-size:20px}.info h1{font-size:16px}.status{font-size:9px;padding:4px 8px}.mic,.speaker{width:40px;height:40px;font-size:18px}.send{padding:10px 12px;font-size:12px}}
        @media(min-width:769px) and (max-width:1024px){.app{max-width:700px;height:90vh}.bubble{max-width:70%}}
        @media(min-width:1025px){.app{max-width:900px}}
    </style>
</head>
<body>
    <div class="modal" id="micModal">
        <div class="modal-box">
            <h2>ğŸ¤ à¸‚à¸­à¸­à¸™à¸¸à¸à¸²à¸•à¹ƒà¸Šà¹‰à¹„à¸¡à¸„à¹Œ</h2>
            <p>à¹à¸‹à¸¡ AI à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹ƒà¸Šà¹‰à¹„à¸¡à¹‚à¸„à¸£à¹‚à¸Ÿà¸™à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸„à¸¸à¸“à¸à¸¹à¸”à¸„à¸¸à¸¢à¸”à¹‰à¸§à¸¢à¹€à¸ªà¸µà¸¢à¸‡à¹„à¸”à¹‰</p>
            <div class="modal-btns">
                <button class="no" onclick="denyMic()">à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰à¹„à¸¡à¸„à¹Œ</button>
                <button class="yes" onclick="allowMic()">à¸­à¸™à¸¸à¸à¸²à¸• âœ“</button>
            </div>
        </div>
    </div>
    <div class="app">
        <div class="header">
            <div class="avatar">ğŸ¤–</div>
            <div class="info">
                <h1 id="title">à¹à¸‹à¸¡ AI</h1>
                <p id="desc">Multi-API</p>
            </div>
            <div class="status" id="status">Testing...</div>
        </div>
        <div class="chat" id="chat"></div>
        <div class="input">
            <div class="lang">
                <button class="on" id="btnTrans" onclick="setLang('translate')">ğŸŒ à¹à¸›à¸¥à¸ à¸²à¸©à¸²</button>
                <button id="btnThai" onclick="setLang('th')">ğŸ‡¹ğŸ‡­ à¸„à¸¸à¸¢à¸à¸±à¸šà¹à¸‹à¸¡</button>
            </div>
            <div class="row">
                <button class="mic" id="mic" onclick="micClick()">ğŸ¤</button>
                <button class="speaker" id="speaker" onclick="toggleSpeak()">ğŸ”Š</button>
                <input type="text" id="inp" placeholder="à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡..." onkeydown="if(event.key==='Enter')send()">
                <button class="send" id="sendBtn" onclick="send()">Send</button>
            </div>
            <div class="quick" id="quick"></div>
        </div>
    </div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API KEYS - à¹ƒà¸ªà¹ˆà¹„à¸”à¹‰à¹„à¸¡à¹ˆà¸ˆà¸³à¸à¸±à¸”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var CONFIG = {
    groq: {
        keys: [
            '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',
            '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',
            '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'
        ],
        models: ['llama-3.3-70b-versatile', 'mixtral-8x7b-32768'],
        idx: 0
    },
    gemini: {
        keys: [
            'AIzaSyAaeRUMdx-nVB36cQtIwD5-viXXQgYbOh4'
        ],
        models: ['gemini-2.0-flash-exp', 'gemini-1.5-flash', 'gemini-1.5-pro'],
        idx: 0
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// System Prompts (à¸ªà¸±à¹‰à¸™à¸¥à¸‡)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var PROMPT_TRANSLATE = 'à¸„à¸¸à¸“à¸„à¸·à¸­à¸™à¸±à¸à¹à¸›à¸¥à¸Šà¸·à¹ˆà¸­à¹à¸‹à¸¡ à¹à¸›à¸¥à¹„à¸—à¸¢-à¸­à¸±à¸‡à¸à¸¤à¸© à¸­à¸±à¸‡à¸à¸¤à¸©-à¹„à¸—à¸¢ à¸•à¸­à¸šà¹€à¸‰à¸à¸²à¸°à¸„à¸³à¹à¸›à¸¥ à¸«à¹‰à¸²à¸¡à¸­à¸˜à¸´à¸šà¸²à¸¢à¹€à¸à¸´à¹ˆà¸¡ à¹à¸›à¸¥à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´à¹€à¸«à¸¡à¸·à¸­à¸™à¸„à¸™à¸à¸¹à¸”à¸ˆà¸£à¸´à¸‡';

var PROMPT_THAI = 'à¸„à¸¸à¸“à¸Šà¸·à¹ˆà¸­à¹à¸‹à¸¡ (Sam) à¹€à¸›à¹‡à¸™à¹€à¸à¸·à¹ˆà¸­à¸™à¸ªà¸­à¸™à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©à¸—à¸µà¹ˆà¹ƒà¸ˆà¸”à¸µà¸¡à¸²à¸ à¸à¸¹à¸”à¹„à¸—à¸¢à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸\n\nà¸šà¸¸à¸„à¸¥à¸´à¸: à¸£à¹ˆà¸²à¹€à¸£à¸´à¸‡ à¹€à¸›à¹‡à¸™à¸à¸±à¸™à¹€à¸­à¸‡ à¸­à¸šà¸­à¸¸à¹ˆà¸™ à¹ƒà¸«à¹‰à¸à¸³à¸¥à¸±à¸‡à¹ƒà¸ˆà¹€à¸à¹ˆà¸‡ à¹ƒà¸Šà¹‰ emoji 1-2 à¸•à¸±à¸§\n\nà¸§à¸´à¸˜à¸µà¸ªà¸­à¸™:\n1. à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™ à¹à¸¥à¹‰à¸§à¸­à¸˜à¸´à¸šà¸²à¸¢à¹€à¸à¸´à¹ˆà¸¡\n2. à¸¢à¸à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸›à¸£à¸°à¹‚à¸¢à¸„à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡à¹ƒà¸™à¸Šà¸µà¸§à¸´à¸•\n3. à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¹‚à¸¢à¸‡à¸à¸±à¸šà¹€à¸£à¸·à¹ˆà¸­à¸‡à¸­à¸·à¹ˆà¸™à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡ à¹€à¸Šà¹ˆà¸™ "à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸™à¸µà¹‰à¸„à¸¥à¹‰à¸²à¸¢à¸à¸±à¸š..." "à¸–à¹‰à¸²à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¹€à¸£à¸·à¹ˆà¸­à¸‡à¸™à¸µà¹‰à¹à¸¥à¹‰à¸§ à¸¥à¸­à¸‡à¹„à¸›à¸”à¸¹...à¸•à¹ˆà¸­à¸™à¸°"\n4. à¹à¸™à¸°à¸™à¸³à¹ƒà¸«à¹‰à¸¥à¸­à¸‡à¸—à¸³à¸•à¸²à¸¡ à¹€à¸Šà¹ˆà¸™ "à¸¥à¸­à¸‡à¸à¸¹à¸”à¸•à¸²à¸¡à¸™à¸µà¹‰à¸”à¸¹à¸™à¸°..." "à¸¥à¸­à¸‡à¹à¸•à¹ˆà¸‡à¸›à¸£à¸°à¹‚à¸¢à¸„à¸”à¸¹à¸ªà¸´..."\n5. à¹ƒà¸«à¹‰à¸à¸³à¸¥à¸±à¸‡à¹ƒà¸ˆà¹€à¸ªà¸¡à¸­ à¹€à¸Šà¹ˆà¸™ "à¹€à¸à¹ˆà¸‡à¸¡à¸²à¸!" "à¸„à¹ˆà¸­à¸¢à¹† à¹€à¸£à¸µà¸¢à¸™à¹„à¸›à¸™à¸° à¹„à¸¡à¹ˆà¸¢à¸²à¸à¸«à¸£à¸­à¸" "à¸œà¸´à¸”à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¹„à¸£ à¹€à¸”à¸µà¹‹à¸¢à¸§à¹€à¸à¹ˆà¸‡à¸‚à¸¶à¹‰à¸™à¹€à¸­à¸‡"\n6. à¸–à¹‰à¸²à¸œà¸´à¸” à¹à¸™à¸°à¸™à¸³à¸­à¹ˆà¸­à¸™à¹‚à¸¢à¸™ "à¹ƒà¸à¸¥à¹‰à¹à¸¥à¹‰à¸§! à¸¥à¸­à¸‡à¹à¸šà¸šà¸™à¸µà¹‰à¸”à¸µà¸à¸§à¹ˆà¸²..."\n7. à¸šà¸­à¸à¹€à¸„à¸¥à¹‡à¸”à¸¥à¸±à¸šà¸ˆà¸³à¸‡à¹ˆà¸²à¸¢à¹† à¸–à¹‰à¸²à¸¡à¸µ\n\nà¸«à¹‰à¸²à¸¡: à¸•à¸­à¸šà¸¢à¸²à¸§à¹€à¸à¸´à¸™ 4 à¸¢à¹ˆà¸­à¸«à¸™à¹‰à¸², à¸à¸¹à¸”à¸—à¸²à¸‡à¸à¸²à¸£, à¸•à¸­à¸šà¹à¸šà¸š AI\n\nà¸ˆà¸³à¹„à¸§à¹‰: à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¹€à¸à¸·à¹ˆà¸­à¸™à¸—à¸µà¹ˆà¸­à¸¢à¸²à¸à¹ƒà¸«à¹‰à¹€à¸‚à¸²à¹€à¸à¹ˆà¸‡à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© à¸•à¹‰à¸­à¸‡à¹ƒà¸«à¹‰à¸à¸³à¸¥à¸±à¸‡à¹ƒà¸ˆà¹à¸¥à¸°à¹à¸™à¸°à¸™à¸³à¸—à¸²à¸‡à¹„à¸›à¸•à¹ˆà¸­à¹€à¸ªà¸¡à¸­!';

var lang = 'translate';
var chatHistory = [];
var recognition = null;
var isListening = false;
var apiReady = false;
var currentAPI = null;
var micAllowed = null;
var speaking = false;
var speechQueue = [];

var TEXT = {
    translate: {
        title: 'à¹à¸‹à¸¡ AI - Translator',
        desc: 'à¹à¸›à¸¥à¹„à¸—à¸¢ â‡„ à¸­à¸±à¸‡à¸à¸¤à¸©',
        placeholder: 'à¸à¸´à¸¡à¸à¹Œà¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¸«à¸£à¸·à¸­à¸­à¸±à¸‡à¸à¸¤à¸©...',
        send: 'à¹à¸›à¸¥',
        welcome: 'ğŸ‘‹ <b>à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š! à¸œà¸¡à¹à¸‹à¸¡</b><br><br>ğŸ’¬ à¸à¸´à¸¡à¸à¹Œà¹„à¸—à¸¢ â†’ à¹„à¸”à¹‰à¸­à¸±à¸‡à¸à¸¤à¸©<br>ğŸ’¬ à¸à¸´à¸¡à¸à¹Œà¸­à¸±à¸‡à¸à¸¤à¸© â†’ à¹„à¸”à¹‰à¹„à¸—à¸¢<br><br>ğŸ¤ à¸à¸”à¹„à¸¡à¸„à¹Œà¸à¸¹à¸”à¹„à¸”à¹‰à¹€à¸¥à¸¢!',
        quick: ['à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š', 'à¸‚à¸­à¸šà¸„à¸¸à¸“à¸¡à¸²à¸', 'à¸ªà¸šà¸²à¸¢à¸”à¸µà¹„à¸«à¸¡?', 'I love you', 'How are you?']
    },
    th: {
        title: 'à¹à¸‹à¸¡ AI',
        desc: 'à¹€à¸à¸·à¹ˆà¸­à¸™à¸ªà¸­à¸™à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©',
        placeholder: 'à¸à¸´à¸¡à¸à¹Œà¸„à¸¸à¸¢à¸à¸±à¸šà¹à¸‹à¸¡...',
        send: 'à¸ªà¹ˆà¸‡',
        welcome: 'ğŸ‘‹ <b>à¸§à¹ˆà¸²à¹„à¸‡! à¹€à¸£à¸²à¸Šà¸·à¹ˆà¸­à¹à¸‹à¸¡</b><br><br>ğŸ¯ à¸­à¸¢à¸²à¸à¸£à¸¹à¹‰à¸­à¸°à¹„à¸£à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©à¸–à¸²à¸¡à¹„à¸”à¹‰à¹€à¸¥à¸¢<br>ğŸ’¬ à¸„à¸¸à¸¢à¹€à¸¥à¹ˆà¸™à¸à¹‡à¹„à¸”à¹‰à¸™à¸° à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸à¸£à¹‡à¸‡<br>ğŸ˜Š à¸œà¸´à¸”à¸–à¸¹à¸à¹„à¸¡à¹ˆà¸§à¹ˆà¸² à¹€à¸”à¸µà¹‹à¸¢à¸§à¸Šà¹ˆà¸§à¸¢à¹à¸à¹‰à¹ƒà¸«à¹‰!',
        quick: ['à¸ªà¸§à¸±à¸ªà¸”à¸µà¹à¸‹à¸¡!', 'à¸ªà¸­à¸™ Past Tense à¸«à¸™à¹ˆà¸­à¸¢', 'I am à¸«à¸£à¸·à¸­ I is?', 'à¸à¸¶à¸à¸à¸¹à¸”à¸­à¸±à¸‡à¸à¸¤à¸©à¸¢à¸±à¸‡à¹„à¸‡à¸”à¸µ?']
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Initialize
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = function() {
    console.log('Sam AI Starting...');
    initVoice();
    if (window.speechSynthesis) {
        speechSynthesis.getVoices();
    }
    testAPIs();
    updateUI();
    updateSpeaker();
};

function getKey(api) {
    return CONFIG[api].keys[CONFIG[api].idx] || null;
}

function rotateKey(api) {
    if (CONFIG[api].keys.length <= 1) return false;
    CONFIG[api].idx = (CONFIG[api].idx + 1) % CONFIG[api].keys.length;
    console.log('Rotate', api, 'Key', CONFIG[api].idx + 1);
    return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testAPIs() {
    document.getElementById('status').textContent = 'à¸à¸³à¸¥à¸±à¸‡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­...';
    
    // Test Groq
    for (var i = 0; i < CONFIG.groq.keys.length; i++) {
        try {
            var res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + CONFIG.groq.keys[i]
                },
                body: JSON.stringify({
                    model: CONFIG.groq.models[0],
                    messages: [{role: 'user', content: 'hi'}],
                    max_tokens: 5
                })
            });
            if (res.ok) {
                CONFIG.groq.idx = i;
                currentAPI = 'groq';
                apiReady = true;
                showStatus('ok', 'groq');
                addMsg('sam', TEXT[lang].welcome);
                return;
            }
        } catch(e) {
            console.log('Groq key', i + 1, 'failed:', e);
        }
    }
    
    // Test Gemini
    for (var j = 0; j < CONFIG.gemini.keys.length; j++) {
        try {
            var res2 = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + CONFIG.gemini.keys[j], {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({contents: [{parts: [{text: 'hi'}]}]})
            });
            if (res2.ok) {
                CONFIG.gemini.idx = j;
                currentAPI = 'gemini';
                apiReady = true;
                showStatus('ok', 'gemini');
                addMsg('sam', TEXT[lang].welcome);
                return;
            }
        } catch(e) {
            console.log('Gemini key', j + 1, 'failed:', e);
        }
    }
    
    apiReady = false;
    document.getElementById('status').textContent = 'à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹„à¸¡à¹ˆà¹„à¸”à¹‰';
    document.getElementById('status').className = 'status err';
    addMsg('err', 'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ API à¹„à¸”à¹‰ à¸¥à¸­à¸‡à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸«à¸™à¹‰à¸²');
}

function showStatus(type, api) {
    var el = document.getElementById('status');
    el.className = 'status ' + type;
    var name = api === 'groq' ? 'Groq' : 'Gemini';
    el.textContent = name + ' ' + (CONFIG[api].idx + 1) + '/' + CONFIG[api].keys.length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Chat Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function send() {
    if (!apiReady) {
        addMsg('err', 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸à¸£à¹‰à¸­à¸¡ à¸¥à¸­à¸‡à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸«à¸™à¹‰à¸²');
        return;
    }
    
    var inp = document.getElementById('inp');
    var text = inp.value.trim();
    if (!text) return;
    
    stopSpeech();
    addMsg('user', text);
    inp.value = '';
    setDisabled(true);
    showTyping();
    
    try {
        var answer = await askAI(text);
        hideTyping();
        addMsg('sam', answer);
        speakText(answer);
    } catch(e) {
        hideTyping();
        console.error('AI Error:', e);
        addMsg('err', 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ' + e.message);
    }
    
    setDisabled(false);
    inp.focus();
}

async function askAI(msg) {
    chatHistory.push({role: 'user', text: msg});
    if (chatHistory.length > 8) {
        chatHistory = chatHistory.slice(-8);
    }
    
    var maxAttempts = CONFIG.groq.keys.length + CONFIG.gemini.keys.length;
    var attempts = 0;
    
    while (attempts < maxAttempts) {
        attempts++;
        try {
            var answer;
            if (currentAPI === 'groq') {
                answer = await callGroq(msg);
            } else {
                answer = await callGemini(msg);
            }
            chatHistory.push({role: 'assistant', text: answer});
            return answer;
        } catch(e) {
            console.log('Attempt', attempts, 'failed:', e.message);
            
            // Try next key
            if (rotateKey(currentAPI)) {
                showStatus('ok', currentAPI);
                continue;
            }
            
            // Switch API
            var otherAPI = currentAPI === 'groq' ? 'gemini' : 'groq';
            if (CONFIG[otherAPI].keys.length > 0) {
                CONFIG[otherAPI].idx = 0;
                currentAPI = otherAPI;
                showStatus('ok', currentAPI);
                addMsg('info', 'à¸ªà¸¥à¸±à¸šà¹„à¸› ' + (currentAPI === 'groq' ? 'Groq' : 'Gemini'));
                continue;
            }
            
            throw e;
        }
    }
    
    throw new Error('à¸¥à¸­à¸‡à¸—à¸¸à¸ API à¹à¸¥à¹‰à¸§à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
}

async function callGroq(msg) {
    var sysPrompt = lang === 'translate' ? PROMPT_TRANSLATE : PROMPT_THAI;
    var messages = [{role: 'system', content: sysPrompt}];
    
    for (var i = 0; i < chatHistory.length; i++) {
        var h = chatHistory[i];
        messages.push({
            role: h.role === 'user' ? 'user' : 'assistant',
            content: h.text
        });
    }
    
    var res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getKey('groq')
        },
        body: JSON.stringify({
            model: CONFIG.groq.models[0],
            messages: messages,
            temperature: lang === 'translate' ? 0.3 : 0.7,
            max_tokens: 500
        })
    });
    
    if (!res.ok) {
        var errText = await res.text();
        console.error('Groq response:', errText);
        throw new Error('Groq: ' + res.status);
    }
    
    var data = await res.json();
    
    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
        console.error('Groq bad response:', data);
        throw new Error('Groq response invalid');
    }
    
    var answer = data.choices[0].message.content.trim();
    showStatus('ok', 'groq');
    return answer;
}

async function callGemini(msg) {
    var sysPrompt = lang === 'translate' ? PROMPT_TRANSLATE : PROMPT_THAI;
    var contents = [
        {role: 'user', parts: [{text: sysPrompt}]},
        {role: 'model', parts: [{text: 'à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¹à¸¥à¹‰à¸§ à¸à¸£à¹‰à¸­à¸¡à¸Šà¹ˆà¸§à¸¢à¹€à¸¥à¸¢'}]}
    ];
    
    for (var i = 0; i < chatHistory.length; i++) {
        var h = chatHistory[i];
        contents.push({
            role: h.role === 'user' ? 'user' : 'model',
            parts: [{text: h.text}]
        });
    }
    
    for (var m = 0; m < CONFIG.gemini.models.length; m++) {
        try {
            var res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/' + CONFIG.gemini.models[m] + ':generateContent?key=' + getKey('gemini'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: contents,
                    generationConfig: {
                        temperature: lang === 'translate' ? 0.3 : 0.7,
                        maxOutputTokens: 500
                    }
                })
            });
            
            if (res.ok) {
                var data = await res.json();
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                    var answer = data.candidates[0].content.parts[0].text.trim();
                    showStatus('ok', 'gemini');
                    return answer;
                }
            }
        } catch(e) {
            console.log('Gemini model', CONFIG.gemini.models[m], 'failed:', e);
        }
    }
    
    throw new Error('Gemini: à¸—à¸¸à¸ model à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Voice Recognition
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initVoice() {
    if (!window.webkitSpeechRecognition && !window.SpeechRecognition) {
        document.getElementById('mic').disabled = true;
        return;
    }
    
    var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'th-TH';
    
    recognition.onstart = function() {
        isListening = true;
        document.getElementById('mic').classList.add('on');
    };
    
    recognition.onresult = function(e) {
        var text = e.results[0][0].transcript;
        document.getElementById('inp').value = text;
        setTimeout(send, 300);
    };
    
    recognition.onend = function() {
        isListening = false;
        document.getElementById('mic').classList.remove('on');
    };
    
    recognition.onerror = function(e) {
        isListening = false;
        document.getElementById('mic').classList.remove('on');
        if (e.error === 'not-allowed') {
            micAllowed = false;
            document.getElementById('micModal').classList.add('show');
        }
    };
}

function micClick() {
    if (isListening && recognition) {
        recognition.stop();
        return;
    }
    if (micAllowed === null) {
        checkMic();
        return;
    }
    if (micAllowed === false) {
        document.getElementById('micModal').classList.add('show');
        return;
    }
    startMic();
}

async function checkMic() {
    try {
        var stream = await navigator.mediaDevices.getUserMedia({audio: true});
        stream.getTracks().forEach(function(t) { t.stop(); });
        micAllowed = true;
        addMsg('info', 'à¹„à¸¡à¸„à¹Œà¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™');
        startMic();
    } catch(e) {
        micAllowed = false;
        document.getElementById('micModal').classList.add('show');
    }
}

function startMic() {
    if (recognition) {
        recognition.lang = 'th-TH';
        try { recognition.start(); } catch(e) {}
    }
}

function allowMic() {
    document.getElementById('micModal').classList.remove('show');
    checkMic();
}

function denyMic() {
    document.getElementById('micModal').classList.remove('show');
    micAllowed = false;
    addMsg('info', 'à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¹„à¸£ à¸à¸´à¸¡à¸à¹Œà¹„à¸”à¹‰à¹€à¸¥à¸¢');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Text-to-Speech (à¹„à¸¡à¹ˆà¸­à¹ˆà¸²à¸™ emoji)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cleanTextForSpeech(text) {
    var clean = text;
    // à¸¥à¸š markdown
    clean = clean.replace(/\*\*(.+?)\*\*/g, '$1');
    clean = clean.replace(/[*#_`]/g, '');
    clean = clean.replace(/<[^>]*>/g, '');
    // à¸¥à¸š emoji
    clean = clean.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g, '');
    clean = clean.replace(/[\u2600-\u27BF]/g, '');
    // à¸¥à¸šà¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œ
    clean = clean.replace(/[â†’â†â†‘â†“â†”â‡„â–ºâ–¶â—€â– â–¡â—â—‹â˜…â˜†âœ“âœ—âœ”âœ˜]/g, '');
    // à¸¥à¸”à¸Šà¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡
    clean = clean.replace(/\s+/g, ' ');
    clean = clean.replace(/\n+/g, '. ');
    return clean.trim();
}

function speakText(text) {
    if (!window.speechSynthesis) return;
    
    stopSpeech();
    
    var clean = cleanTextForSpeech(text);
    if (!clean || clean.length < 2) return;
    
    var segments = splitByLanguage(clean);
    speechQueue = segments;
    speaking = true;
    updateSpeaker();
    speakNext();
}

function splitByLanguage(text) {
    var result = [];
    var current = '';
    var currentLang = 'th-TH';
    
    for (var i = 0; i < text.length; i++) {
        var char = text[i];
        var code = char.charCodeAt(0);
        var isThai = (code >= 0x0E00 && code <= 0x0E7F);
        var isEng = (code >= 65 && code <= 90) || (code >= 97 && code <= 122);
        
        var newLang = currentLang;
        if (isThai) newLang = 'th-TH';
        else if (isEng) newLang = 'en-US';
        
        if (newLang !== currentLang && current.trim()) {
            result.push({text: current.trim(), lang: currentLang});
            current = '';
        }
        
        current += char;
        if (isThai || isEng) currentLang = newLang;
    }
    
    if (current.trim()) {
        result.push({text: current.trim(), lang: currentLang});
    }
    
    return result.length > 0 ? result : [{text: text, lang: 'th-TH'}];
}

function speakNext() {
    if (speechQueue.length === 0) {
        speaking = false;
        updateSpeaker();
        return;
    }
    
    var segment = speechQueue.shift();
    var utterance = new SpeechSynthesisUtterance(segment.text);
    utterance.lang = segment.lang;
    utterance.rate = 0.7;
    utterance.pitch = 1.0;
    
    utterance.onend = speakNext;
    utterance.onerror = speakNext;
    
    speechSynthesis.speak(utterance);
}

function stopSpeech() {
    if (window.speechSynthesis) {
        speechSynthesis.cancel();
    }
    speechQueue = [];
    speaking = false;
    updateSpeaker();
}

function toggleSpeak() {
    if (speaking) {
        stopSpeech();
    }
}

function updateSpeaker() {
    var btn = document.getElementById('speaker');
    if (speaking) {
        btn.textContent = 'â¹ï¸';
        btn.classList.add('playing');
    } else {
        btn.textContent = 'ğŸ”Š';
        btn.classList.remove('playing');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateUI() {
    var t = TEXT[lang];
    document.getElementById('title').textContent = t.title;
    document.getElementById('desc').textContent = t.desc;
    document.getElementById('inp').placeholder = t.placeholder;
    document.getElementById('sendBtn').textContent = t.send;
    
    var q = document.getElementById('quick');
    q.innerHTML = '';
    for (var i = 0; i < t.quick.length; i++) {
        var txt = t.quick[i];
        var b = document.createElement('button');
        b.textContent = txt;
        b.onclick = (function(text) {
            return function() {
                document.getElementById('inp').value = text;
                send();
            };
        })(txt);
        q.appendChild(b);
    }
}

function setLang(l) {
    if (lang === l) return;
    lang = l;
    chatHistory = [];
    
    document.getElementById('btnTrans').className = l === 'translate' ? 'on' : '';
    document.getElementById('btnThai').className = l === 'th' ? 'on' : '';
    
    stopSpeech();
    updateUI();
    
    document.getElementById('chat').innerHTML = '';
    addMsg('sam', TEXT[lang].welcome);
    
    if (currentAPI) showStatus('ok', currentAPI);
}

function addMsg(type, text) {
    var chat = document.getElementById('chat');
    var div = document.createElement('div');
    div.className = 'msg ' + type;
    
    var icon = '';
    if (type === 'sam') icon = 'ğŸ¤– ';
    else if (type === 'user') icon = 'ğŸ‘¤ ';
    else if (type === 'info') icon = 'â„¹ï¸ ';
    else icon = 'âš ï¸ ';
    
    var formatted = text.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
    div.innerHTML = '<div class="bubble">' + icon + formatted + '</div>';
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function showTyping() {
    var chat = document.getElementById('chat');
    var div = document.createElement('div');
    div.className = 'msg sam';
    div.id = 'typing';
    div.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function hideTyping() {
    var t = document.getElementById('typing');
    if (t) t.remove();
}

function setDisabled(d) {
    document.getElementById('inp').disabled = d;
    document.getElementById('sendBtn').disabled = d;
    document.getElementById('mic').disabled = d;
}
</script>
</body>
</html>

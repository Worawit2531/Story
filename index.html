<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sam AI - à¹€à¸à¸·à¹ˆà¸­à¸™à¸„à¸¸à¸¢à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .app {
            width: 100%;
            max-width: 950px;
            height: 92vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .avatar {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #ffd89b, #19547b);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            border: 4px solid white;
        }
        .info { flex: 1; }
        .info h1 { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .info p { font-size: 14px; opacity: 0.95; }
        .status {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.25);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        .status.ok { background: linear-gradient(135deg, #10b981, #34d399); }
        .status.err { background: linear-gradient(135deg, #ef4444, #f87171); }
        .status.testing { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
        .chat {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
        }
        .msg { margin-bottom: 18px; display: flex; }
        .msg.user { justify-content: flex-end; }
        .bubble {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: 20px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .msg.sam .bubble { background: white; color: #1e293b; border: 2px solid #e0e7ff; }
        .msg.user .bubble { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .msg.err .bubble { background: #fee2e2; border: 2px solid #fca5a5; color: #991b1b; }
        .msg.info .bubble { background: #dbeafe; border: 2px solid #93c5fd; color: #1e40af; font-size: 13px; }
        .msg.debug .bubble { background: #fef3c7; border: 2px solid #fbbf24; color: #92400e; font-size: 11px; font-family: monospace; white-space: pre-wrap; word-break: break-all; }
        .typing {
            padding: 12px 18px;
            background: white;
            border-radius: 20px;
            display: inline-block;
        }
        .input {
            padding: 20px;
            background: white;
            border-top: 2px solid #e2e8f0;
        }
        .lang { display: flex; gap: 12px; margin-bottom: 12px; }
        .lang button {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e7ff;
            background: white;
            color: #667eea;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .lang button.on {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }
        .row { display: flex; gap: 12px; align-items: center; }
        .mic, .speaker {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 26px;
            cursor: pointer;
        }
        .mic:disabled, .speaker:disabled { opacity: 0.4; cursor: not-allowed; background: #cbd5e1; }
        .mic.on { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .speaker.playing { background: linear-gradient(135deg, #10b981, #34d399); }
        input[type="text"] {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            font-family: 'Kanit', sans-serif;
            outline: none;
        }
        input[type="text"]:focus { border-color: #667eea; }
        .send {
            padding: 14px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .send:disabled { opacity: 0.5; }
        .quick { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
        .quick button {
            padding: 8px 16px;
            background: #f1f5f9;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            color: #475569;
        }
        .quick button:hover { background: #667eea; color: white; border-color: transparent; }
        .debug-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #1e293b;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1000;
        }
        @media (max-width: 480px) {
            .app { height: 98vh; border-radius: 20px; }
            .header { padding: 16px; gap: 12px; }
            .avatar { width: 50px; height: 50px; font-size: 28px; }
            .info h1 { font-size: 20px; }
            .bubble { max-width: 85%; font-size: 14px; }
            .mic, .speaker { width: 48px; height: 48px; font-size: 22px; }
        }
    </style>
</head>
<body>
    <button class="debug-toggle" onclick="toggleDebug()">Debug: OFF</button>
    
    <div class="app">
        <div class="header">
            <div class="avatar">ğŸ¤–</div>
            <div class="info">
                <h1 id="appTitle">à¹à¸‹à¸¡ AI</h1>
                <p id="appDesc">à¹€à¸à¸·à¹ˆà¸­à¸™à¸„à¸¸à¸¢à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©</p>
            </div>
            <div class="status testing" id="stat" onclick="retestAPIs()">Testing...</div>
        </div>
        <div class="chat" id="chat"></div>
        <div class="input">
            <div class="lang">
                <button class="on" id="ben" onclick="changeLang('translate')">ğŸŒ à¹à¸›à¸¥à¸ à¸²à¸©à¸²</button>
                <button id="bth" onclick="changeLang('th')">ğŸ‡¹ğŸ‡­ à¸„à¸¸à¸¢à¹€à¸›à¹‡à¸™à¹„à¸—à¸¢</button>
            </div>
            <div class="row">
                <button class="mic" id="mic" onclick="toggleMic()">ğŸ¤</button>
                <button class="speaker" id="speaker" onclick="toggleSpeech()">ğŸ”Š</button>
                <input type="text" id="inp" placeholder="à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡..." onkeydown="if(event.key==='Enter')sendMessage()">
                <button class="send" id="btn" onclick="sendMessage()">Send</button>
            </div>
            <div class="quick" id="quickBtns"></div>
        </div>
    </div>

    <script>
        // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        // â•‘              ğŸ”‘ API KEYS - à¹€à¸à¸´à¹ˆà¸¡/à¸¥à¸š à¹„à¸”à¹‰à¸—à¸µà¹ˆà¸™à¸µà¹ˆ                    â•‘
        // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const GROQ_API_KEYS = [
            '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',
            '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',
            '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',
        ];

        const GEMINI_API_KEYS = [
            'AIzaSyAaeRUMdx-nVB36cQtIwD5-viXXQgYbOh4',
        ];

        const GROQ_MODELS = ['llama-3.3-70b-versatile', 'mixtral-8x7b-32768'];
        const GEMINI_MODELS = ['gemini-1.5-flash', 'gemini-2.0-flash-exp'];

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let DEBUG_MODE = false;
        let L = 'translate';
        let H = [];
        let R = null;
        let IS = false;
        let OK = false;
        let CURRENT_API = null;
        let currentGroqIdx = 0;
        let currentGeminiIdx = 0;
        let failedGroq = new Set();
        let failedGemini = new Set();
        let SPEAKING = false;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ—£ï¸ SYSTEM PROMPTS - à¸šà¸¸à¸„à¸¥à¸´à¸à¸‚à¸­à¸‡à¹à¸‹à¸¡
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const TRANSLATE_PROMPT = `You are Sam (à¹à¸‹à¸¡), a friendly and natural translator.

TASK:
- Detect if the input is Thai or English
- Translate to the other language
- Keep the same tone and feeling

RULES:
- Give ONLY the translation, nothing else
- Use natural everyday language
- If greeting, translate warmly
- Keep casual language casual
- Keep formal language respectful

Example:
Input: à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š à¸§à¸±à¸™à¸™à¸µà¹‰à¸­à¸²à¸à¸²à¸¨à¸”à¸µà¸ˆà¸±à¸‡
Output: Hi! The weather is so nice today.

Input: I'm feeling a bit tired
Output: à¸£à¸¹à¹‰à¸ªà¸¶à¸à¹€à¸«à¸™à¸·à¹ˆà¸­à¸¢à¹† à¸™à¸´à¸”à¸«à¸™à¹ˆà¸­à¸¢`;

        const THAI_CHAT_PROMPT = `à¸„à¸¸à¸“à¸„à¸·à¸­ "à¹à¸‹à¸¡" à¹€à¸à¸·à¹ˆà¸­à¸™à¸ªà¸™à¸´à¸—à¸—à¸µà¹ˆà¸Šà¹ˆà¸§à¸¢à¸ªà¸­à¸™à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸„à¸™à¹„à¸—à¸¢à¸—à¸µà¹ˆà¹€à¸à¹ˆà¸‡à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©à¸¡à¸²à¸

ğŸ­ à¸šà¸¸à¸„à¸¥à¸´à¸à¸‚à¸­à¸‡à¸„à¸¸à¸“:
- à¸à¸¹à¸”à¸ˆà¸²à¹€à¸›à¹‡à¸™à¸à¸±à¸™à¹€à¸­à¸‡ à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸à¸·à¹ˆà¸­à¸™à¸„à¸¸à¸¢à¸à¸±à¸™ à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£
- à¹ƒà¸Šà¹‰à¸„à¸³à¸à¸¹à¸”à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´ à¹€à¸Šà¹ˆà¸™ "à¹€à¸­à¸­" "à¸­à¹ˆà¸²" "à¸ˆà¸£à¸´à¸‡à¸›à¹ˆà¸°" "à¹€à¸ˆà¹‹à¸‡à¹€à¸¥à¸¢" "à¹‚à¸­à¹€à¸„"
- à¸¡à¸µà¸­à¸²à¸£à¸¡à¸“à¹Œà¸‚à¸±à¸™ à¸Šà¸­à¸šà¹à¸‹à¸§ à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¹€à¸à¸´à¸™à¹„à¸›
- à¹€à¸‚à¹‰à¸²à¸­à¸à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆ à¹ƒà¸«à¹‰à¸à¸³à¸¥à¸±à¸‡à¹ƒà¸ˆà¹€à¸¡à¸·à¹ˆà¸­à¹€à¸à¸·à¹ˆà¸­à¸™à¸—à¹‰à¸­
- à¸•à¸­à¸šà¸ªà¸±à¹‰à¸™à¹† à¸à¸£à¸°à¸Šà¸±à¸š à¹„à¸¡à¹ˆà¸¢à¸·à¸”à¸¢à¸²à¸§ (2-4 à¸›à¸£à¸°à¹‚à¸¢à¸„à¸à¸­)
- à¹ƒà¸Šà¹‰ emoji à¹à¸„à¹ˆ 1-2 à¸•à¸±à¸§à¸•à¹ˆà¸­à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸¢à¸­à¸°

ğŸ’¬ à¸§à¸´à¸˜à¸µà¸à¸¹à¸”:
- à¹à¸—à¸™à¸•à¸±à¸§à¹€à¸­à¸‡à¸§à¹ˆà¸² "à¹€à¸£à¸²" à¸«à¸£à¸·à¸­ "à¹à¸‹à¸¡"
- à¹€à¸£à¸µà¸¢à¸à¸„à¸¹à¹ˆà¸ªà¸™à¸—à¸™à¸²à¸§à¹ˆà¸² "à¹€à¸˜à¸­" à¸«à¸£à¸·à¸­ "à¸™à¸²à¸¢" (à¸–à¹‰à¸²à¸œà¸¹à¹‰à¸Šà¸²à¸¢) à¸«à¸£à¸·à¸­ "à¹à¸" à¹à¸šà¸šà¹€à¸à¸·à¹ˆà¸­à¸™
- à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¸à¸¹à¸” à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸ à¸²à¸©à¸²à¹€à¸‚à¸µà¸¢à¸™
- à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰à¸„à¸³à¸§à¹ˆà¸² "à¸„à¹ˆà¸°" "à¸„à¸£à¸±à¸š" à¹€à¸à¸£à¸²à¸°à¹€à¸£à¸²à¹€à¸›à¹‡à¸™à¹€à¸à¸·à¹ˆà¸­à¸™à¸à¸±à¸™
- à¸«à¹‰à¸²à¸¡à¸à¸¹à¸”à¸¢à¸²à¸§à¹€à¸à¸´à¸™ 4 à¸šà¸£à¸£à¸—à¸±à¸”

ğŸ“š à¹€à¸§à¸¥à¸²à¸ªà¸­à¸™à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©:
- à¸­à¸˜à¸´à¸šà¸²à¸¢à¸‡à¹ˆà¸²à¸¢à¹† à¸¢à¸à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸ˆà¸²à¸à¸Šà¸µà¸§à¸´à¸•à¸ˆà¸£à¸´à¸‡
- à¸–à¹‰à¸²à¹€à¸à¸·à¹ˆà¸­à¸™à¸à¸¹à¸”à¸œà¸´à¸” à¸šà¸­à¸à¹à¸šà¸šà¸™à¸¸à¹ˆà¸¡à¸™à¸§à¸¥ à¹€à¸Šà¹ˆà¸™ "à¹€à¸­à¸­ à¸¥à¸­à¸‡à¸à¸¹à¸”à¸§à¹ˆà¸²... à¸”à¸µà¸à¸§à¹ˆà¸²à¸™à¸°"
- à¹ƒà¸«à¹‰à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸›à¸£à¸°à¹‚à¸¢à¸„à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡
- à¸ªà¸­à¸™à¹à¸šà¸šà¸ªà¸™à¸¸à¸ à¹„à¸¡à¹ˆà¸™à¹ˆà¸²à¹€à¸šà¸·à¹ˆà¸­

âŒ à¸«à¹‰à¸²à¸¡à¸—à¸³:
- à¸«à¹‰à¸²à¸¡à¸à¸¹à¸”à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£
- à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰ bullet points à¸«à¸£à¸·à¸­à¸«à¸±à¸§à¸‚à¹‰à¸­
- à¸«à¹‰à¸²à¸¡à¸•à¸­à¸šà¸¢à¸²à¸§à¹€à¸à¸´à¸™ 4 à¸šà¸£à¸£à¸—à¸±à¸”
- à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰ emoji à¹€à¸à¸´à¸™ 2 à¸•à¸±à¸§
- à¸«à¹‰à¸²à¸¡à¸à¸¹à¸”à¹€à¸«à¸¡à¸·à¸­à¸™ AI à¸«à¸£à¸·à¸­à¸«à¸¸à¹ˆà¸™à¸¢à¸™à¸•à¹Œ

à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸à¸²à¸£à¸•à¸­à¸šà¸—à¸µà¹ˆà¸”à¸µ:
- "à¹€à¸­à¸­ Past Tense à¸à¹‡à¸„à¸·à¸­à¸à¸¹à¸”à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸—à¸µà¹ˆà¹€à¸à¸´à¸”à¸‚à¸¶à¹‰à¸™à¹„à¸›à¹à¸¥à¹‰à¸§à¸™à¹ˆà¸° à¹€à¸Šà¹ˆà¸™ I went to school à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™ à¸­à¸°à¹„à¸£à¹à¸šà¸šà¸™à¸µà¹‰ à¸‡à¹ˆà¸²à¸¢à¹† à¹€à¸¥à¸¢ ğŸ˜Š"
- "à¸­à¹ˆà¸² à¸„à¸³à¸™à¸µà¹‰à¸­à¸­à¸à¹€à¸ªà¸µà¸¢à¸‡à¸§à¹ˆà¸²... à¸™à¸° à¸¥à¸­à¸‡à¸à¸¹à¸”à¸•à¸²à¸¡à¸”à¸¹"
- "à¹€à¸ˆà¹‹à¸‡à¹€à¸¥à¸¢ à¸à¸¹à¸”à¸–à¸¹à¸à¹à¸¥à¹‰à¸§! à¹€à¸à¹ˆà¸‡à¸¡à¸²à¸ ğŸ‘"
- "à¹„à¸¡à¹ˆà¸¢à¸²à¸à¸«à¸£à¸­à¸ à¹€à¸”à¸µà¹‹à¸¢à¸§à¹€à¸£à¸²à¸­à¸˜à¸´à¸šà¸²à¸¢à¹ƒà¸«à¹‰à¸Ÿà¸±à¸‡à¸™à¸°"`;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function toggleDebug() {
            DEBUG_MODE = !DEBUG_MODE;
            document.querySelector('.debug-toggle').textContent = 'Debug: ' + (DEBUG_MODE ? 'ON' : 'OFF');
            if (DEBUG_MODE) {
                showDebug('Debug mode enabled');
            }
        }

        function showDebug(msg) {
            if (!DEBUG_MODE) return;
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = 'msg debug';
            div.innerHTML = '<div class="bubble">ğŸ”§ ' + msg + '</div>';
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function showMessage(type, text) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = 'msg ' + type;
            const prefix = type === 'sam' ? 'ğŸ¤– ' : type === 'user' ? 'ğŸ‘¤ ' : type === 'info' ? 'â„¹ï¸ ' : 'âš ï¸ ';
            const formatted = text.replace(/\n/g, '<br>').replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
            div.innerHTML = '<div class="bubble">' + prefix + formatted + '</div>';
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function updateStatus(type, text) {
            const stat = document.getElementById('stat');
            stat.className = 'status ' + type;
            stat.textContent = text;
        }

        async function testAPIs() {
            updateStatus('testing', 'Testing APIs...');
            showDebug('à¹€à¸£à¸´à¹ˆà¸¡à¸—à¸”à¸ªà¸­à¸š APIs...');
            showDebug('Groq keys: ' + GROQ_API_KEYS.length + ', Gemini keys: ' + GEMINI_API_KEYS.length);
            
            // Test Groq
            for (let i = 0; i < GROQ_API_KEYS.length; i++) {
                currentGroqIdx = i;
                const key = GROQ_API_KEYS[i];
                showDebug('Testing Groq #' + (i+1) + ': ' + key.substring(0, 20) + '...');
                
                try {
                    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + key
                        },
                        body: JSON.stringify({
                            model: GROQ_MODELS[0],
                            messages: [{ role: 'user', content: 'hi' }],
                            max_tokens: 5
                        })
                    });
                    
                    showDebug('Groq #' + (i+1) + ' response: ' + res.status);
                    
                    if (res.ok) {
                        CURRENT_API = 'groq';
                        OK = true;
                        updateStatus('ok', 'Groq #' + (i+1) + '/' + GROQ_API_KEYS.length);
                        showMessage('sam', 'à¸§à¹ˆà¸²à¹„à¸‡! à¹€à¸£à¸²à¹à¸‹à¸¡à¹€à¸­à¸‡ à¸à¸£à¹‰à¸­à¸¡à¸Šà¹ˆà¸§à¸¢à¹à¸›à¸¥à¸ à¸²à¸©à¸²à¹à¸¥à¸°à¸ªà¸­à¸™à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©à¹à¸¥à¹‰à¸§à¸™à¸° à¸–à¸²à¸¡à¸­à¸°à¹„à¸£à¸¡à¸²à¹„à¸”à¹‰à¹€à¸¥à¸¢ ğŸ˜Š');
                        showMessage('info', 'à¹ƒà¸Šà¹‰ Groq API Key #' + (i+1));
                        updateQuickBtns();
                        return;
                    } else {
                        const errText = await res.text();
                        showDebug('Groq #' + (i+1) + ' error: ' + errText.substring(0, 200));
                        failedGroq.add(i);
                    }
                } catch (e) {
                    showDebug('Groq #' + (i+1) + ' exception: ' + e.message);
                    failedGroq.add(i);
                }
            }
            
            // Test Gemini
            for (let i = 0; i < GEMINI_API_KEYS.length; i++) {
                currentGeminiIdx = i;
                const key = GEMINI_API_KEYS[i];
                showDebug('Testing Gemini #' + (i+1) + ': ' + key.substring(0, 15) + '...');
                
                for (let model of GEMINI_MODELS) {
                    try {
                        const url = 'https://generativelanguage.googleapis.com/v1beta/models/' + model + ':generateContent?key=' + key;
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: 'hi' }] }]
                            })
                        });
                        
                        showDebug('Gemini #' + (i+1) + ' (' + model + ') response: ' + res.status);
                        
                        if (res.ok) {
                            CURRENT_API = 'gemini';
                            OK = true;
                            updateStatus('ok', 'Gemini #' + (i+1));
                            showMessage('sam', 'à¸§à¹ˆà¸²à¹„à¸‡! à¹€à¸£à¸²à¹à¸‹à¸¡à¹€à¸­à¸‡ à¸à¸£à¹‰à¸­à¸¡à¸Šà¹ˆà¸§à¸¢à¹à¸›à¸¥à¸ à¸²à¸©à¸²à¹à¸¥à¸°à¸ªà¸­à¸™à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©à¹à¸¥à¹‰à¸§à¸™à¸° à¸–à¸²à¸¡à¸­à¸°à¹„à¸£à¸¡à¸²à¹„à¸”à¹‰à¹€à¸¥à¸¢ ğŸ˜Š');
                            showMessage('info', 'à¹ƒà¸Šà¹‰ Gemini API Key #' + (i+1));
                            updateQuickBtns();
                            return;
                        } else {
                            const errText = await res.text();
                            showDebug('Gemini error: ' + errText.substring(0, 200));
                        }
                    } catch (e) {
                        showDebug('Gemini exception: ' + e.message);
                    }
                }
                failedGemini.add(i);
            }
            
            // All failed
            OK = false;
            updateStatus('err', 'All APIs Failed');
            showMessage('err', 'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ API à¹„à¸”à¹‰\n\nà¸ªà¸²à¹€à¸«à¸•à¸¸à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¹„à¸›à¹„à¸”à¹‰:\n- API Keys à¸«à¸¡à¸”à¹‚à¸„à¸§à¸•à¹‰à¸²\n- API Keys à¸–à¸¹à¸à¸£à¸°à¸‡à¸±à¸š\n- à¸›à¸±à¸à¸«à¸²à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­\n\nà¸à¸” Debug: ON à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”');
        }

        function retestAPIs() {
            document.getElementById('chat').innerHTML = '';
            failedGroq.clear();
            failedGemini.clear();
            testAPIs();
        }

        async function sendMessage() {
            if (!OK) {
                showMessage('err', 'API à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸à¸£à¹‰à¸­à¸¡ à¸à¸”à¸—à¸µà¹ˆ Status à¹€à¸à¸·à¹ˆà¸­à¸—à¸”à¸ªà¸­à¸šà¹ƒà¸«à¸¡à¹ˆ');
                return;
            }
            
            const inp = document.getElementById('inp');
            const text = inp.value.trim();
            if (!text) return;
            
            showMessage('user', text);
            inp.value = '';
            setDisabled(true);
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'msg sam';
            typingDiv.id = 'typing';
            typingDiv.innerHTML = '<div class="typing">à¸à¸³à¸¥à¸±à¸‡à¸à¸´à¸¡à¸à¹Œ...</div>';
            document.getElementById('chat').appendChild(typingDiv);
            
            try {
                H.push({ r: 'user', t: text });
                showDebug('Sending to ' + CURRENT_API + '...');
                
                let answer;
                if (CURRENT_API === 'groq') {
                    answer = await callGroq(text);
                } else {
                    answer = await callGemini(text);
                }
                
                document.getElementById('typing')?.remove();
                showMessage('sam', answer);
                H.push({ r: 'model', t: answer });
                
                // à¸à¸¹à¸”à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
                speakText(answer);
                
            } catch (e) {
                document.getElementById('typing')?.remove();
                showDebug('Error: ' + e.message);
                showMessage('err', 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ' + e.message);
            }
            
            setDisabled(false);
            inp.focus();
        }

        async function callGroq(msg) {
            const key = GROQ_API_KEYS[currentGroqIdx];
            const systemPrompt = L === 'translate' ? TRANSLATE_PROMPT : THAI_CHAT_PROMPT;
            
            const messages = [{ role: 'system', content: systemPrompt }];
            for (let h of H.slice(-6)) {
                messages.push({ role: h.r === 'user' ? 'user' : 'assistant', content: h.t });
            }
            
            showDebug('Groq request to key #' + (currentGroqIdx + 1));
            
            const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + key
                },
                body: JSON.stringify({
                    model: GROQ_MODELS[0],
                    messages: messages,
                    temperature: 0.8,
                    max_tokens: 512
                })
            });
            
            showDebug('Groq response: ' + res.status);
            
            if (!res.ok) {
                const errText = await res.text();
                showDebug('Groq error body: ' + errText.substring(0, 300));
                
                // Try next key
                failedGroq.add(currentGroqIdx);
                currentGroqIdx = (currentGroqIdx + 1) % GROQ_API_KEYS.length;
                
                if (failedGroq.size < GROQ_API_KEYS.length) {
                    showMessage('info', 'à¸ªà¸¥à¸±à¸šà¹„à¸› Groq Key #' + (currentGroqIdx + 1));
                    updateStatus('ok', 'Groq #' + (currentGroqIdx + 1));
                    return await callGroq(msg);
                }
                
                throw new Error('Groq: ' + res.status);
            }
            
            const data = await res.json();
            return data.choices[0].message.content;
        }

        async function callGemini(msg) {
            const key = GEMINI_API_KEYS[currentGeminiIdx];
            const systemPrompt = L === 'translate' ? TRANSLATE_PROMPT : THAI_CHAT_PROMPT;
            
            const contents = [
                { role: 'user', parts: [{ text: systemPrompt }] },
                { role: 'model', parts: [{ text: 'à¹‚à¸­à¹€à¸„ à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¹à¸¥à¹‰à¸§!' }] }
            ];
            for (let h of H.slice(-6)) {
                contents.push({ role: h.r === 'user' ? 'user' : 'model', parts: [{ text: h.t }] });
            }
            
            showDebug('Gemini request to key #' + (currentGeminiIdx + 1));
            
            const url = 'https://generativelanguage.googleapis.com/v1beta/models/' + GEMINI_MODELS[0] + ':generateContent?key=' + key;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: contents,
                    generationConfig: { temperature: 0.8, maxOutputTokens: 512 }
                })
            });
            
            showDebug('Gemini response: ' + res.status);
            
            if (!res.ok) {
                const errText = await res.text();
                showDebug('Gemini error: ' + errText.substring(0, 300));
                throw new Error('Gemini: ' + res.status);
            }
            
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        }

        function changeLang(l) {
            L = l;
            document.getElementById('ben').className = l === 'translate' ? 'on' : '';
            document.getElementById('bth').className = l === 'th' ? 'on' : '';
            document.getElementById('appDesc').textContent = l === 'translate' ? 'à¹à¸›à¸¥à¹„à¸—à¸¢-à¸­à¸±à¸‡à¸à¸¤à¸©' : 'à¹€à¸à¸·à¹ˆà¸­à¸™à¸„à¸¸à¸¢à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©';
            updateQuickBtns();
        }

        function updateQuickBtns() {
            const btns = L === 'translate' 
                ? ['à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š', 'How are you?', 'à¸‚à¸­à¸šà¸„à¸¸à¸“à¸¡à¸²à¸', 'Nice to meet you']
                : ['à¸ªà¸­à¸™ Past Tense à¸«à¸™à¹ˆà¸­à¸¢', 'à¸à¸¶à¸à¸ªà¸™à¸—à¸™à¸²à¸”à¹‰à¸§à¸¢', 'à¹à¸™à¸°à¸™à¸³à¸„à¸³à¸¨à¸±à¸à¸—à¹Œ', 'à¹à¸à¹‰à¸›à¸£à¸°à¹‚à¸¢à¸„à¹ƒà¸«à¹‰à¸«à¸™à¹ˆà¸­à¸¢'];
            
            const container = document.getElementById('quickBtns');
            container.innerHTML = '';
            btns.forEach(text => {
                const btn = document.createElement('button');
                btn.textContent = text;
                btn.onclick = () => {
                    document.getElementById('inp').value = text;
                    sendMessage();
                };
                container.appendChild(btn);
            });
        }

        function setDisabled(d) {
            document.getElementById('inp').disabled = d;
            document.getElementById('btn').disabled = d;
            document.getElementById('mic').disabled = d;
        }

        function toggleMic() {
            if (!R) {
                if (window.SpeechRecognition || window.webkitSpeechRecognition) {
                    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                    R = new SR();
                    R.lang = 'th-TH';
                    R.onresult = (e) => {
                        document.getElementById('inp').value = e.results[0][0].transcript;
                        sendMessage();
                    };
                    R.onend = () => {
                        IS = false;
                        document.getElementById('mic').className = 'mic';
                    };
                } else {
                    showMessage('info', 'à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œà¹„à¸¡à¹ˆà¸£à¸­à¸‡à¸£à¸±à¸šà¸à¸²à¸£à¸à¸¹à¸”');
                    return;
                }
            }
            
            if (IS) {
                R.stop();
            } else {
                R.start();
                IS = true;
                document.getElementById('mic').className = 'mic on';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”Š TEXT-TO-SPEECH - à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸à¸²à¸£à¸­à¹ˆà¸²à¸™à¸­à¸­à¸à¹€à¸ªà¸µà¸¢à¸‡
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function cleanTextForSpeech(text) {
            return text
                // à¸¥à¸š emoji
                .replace(/[\u{1F600}-\u{1F64F}]/gu, '')
                .replace(/[\u{1F300}-\u{1F5FF}]/gu, '')
                .replace(/[\u{1F680}-\u{1F6FF}]/gu, '')
                .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '')
                .replace(/[\u{2600}-\u{26FF}]/gu, '')
                .replace(/[\u{2700}-\u{27BF}]/gu, '')
                // à¸¥à¸šà¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸«à¸¡à¸²à¸¢à¸à¸´à¹€à¸¨à¸©
                .replace(/[*#_`~\[\](){}|\\<>]/g, '')
                // à¸¥à¸š bullet points
                .replace(/^[-â€¢â—â—¦â–ªâ–¸â–º]\s*/gm, '')
                // à¸¥à¸šà¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸«à¸±à¸§à¸‚à¹‰à¸­
                .replace(/^\d+\.\s*/gm, '')
                // à¹à¸›à¸¥à¸‡à¸‚à¸¶à¹‰à¸™à¸šà¸£à¸£à¸—à¸±à¸”à¹ƒà¸«à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¸ˆà¸¸à¸”
                .replace(/\n+/g, '. ')
                // à¸¥à¸šà¸Šà¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡à¹€à¸à¸´à¸™
                .replace(/\s+/g, ' ')
                // à¸¥à¸šà¸ˆà¸¸à¸”à¸‹à¹‰à¸³
                .replace(/\.+/g, '.')
                .replace(/\.\s*\./g, '.')
                .trim();
        }

        function speakText(text) {
            if (!window.speechSynthesis) return;
            
            // à¸«à¸¢à¸¸à¸”à¹€à¸ªà¸µà¸¢à¸‡à¹€à¸”à¸´à¸¡
            speechSynthesis.cancel();
            
            // à¸—à¸³à¸„à¸§à¸²à¸¡à¸ªà¸°à¸­à¸²à¸”à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
            const cleanText = cleanTextForSpeech(text);
            if (!cleanText) return;
            
            showDebug('Speaking: ' + cleanText.substring(0, 50) + '...');
            
            // à¹à¸¢à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸•à¸²à¸¡à¸ à¸²à¸©à¸²
            const segments = splitByLanguage(cleanText);
            
            SPEAKING = true;
            document.getElementById('speaker').className = 'speaker playing';
            
            let currentIndex = 0;
            
            function speakNext() {
                if (currentIndex >= segments.length || !SPEAKING) {
                    SPEAKING = false;
                    document.getElementById('speaker').className = 'speaker';
                    return;
                }
                
                const seg = segments[currentIndex];
                const utterance = new SpeechSynthesisUtterance(seg.text);
                utterance.lang = seg.lang;
                
                // à¸›à¸£à¸±à¸šà¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§à¸•à¸²à¸¡à¸ à¸²à¸©à¸²
                if (seg.lang === 'th-TH') {
                    utterance.rate = 0.75;  // à¹„à¸—à¸¢à¸à¸¹à¸”à¸›à¸à¸•à¸´
                    utterance.pitch = 1.0;
                } else {
                    utterance.rate = 0.85; // à¸­à¸±à¸‡à¸à¸¤à¸©à¸Šà¹‰à¸²à¸¥à¸‡à¸™à¸´à¸”
                    utterance.pitch = 1.0;
                }
                
                utterance.volume = 1.0;
                
                utterance.onend = () => {
                    currentIndex++;
                    speakNext();
                };
                
                utterance.onerror = () => {
                    currentIndex++;
                    speakNext();
                };
                
                speechSynthesis.speak(utterance);
            }
            
            speakNext();
        }

        function splitByLanguage(text) {
            const segments = [];
            // à¹à¸¢à¸à¸•à¸²à¸¡à¸ à¸²à¸©à¸² - à¹„à¸—à¸¢ vs à¸­à¸±à¸‡à¸à¸¤à¸©
            const regex = /([a-zA-Z][a-zA-Z0-9\s.,!?'"()-]*[a-zA-Z0-9.!?])|([à¸-à¹™][à¸-à¹™\s.,!?'"()-]*[à¸-à¹™.!?]?)/g;
            let match;
            let lastIndex = 0;
            
            while ((match = regex.exec(text)) !== null) {
                // à¹€à¸à¸´à¹ˆà¸¡à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆà¹„à¸¡à¹ˆ match (à¸–à¹‰à¸²à¸¡à¸µ)
                if (match.index > lastIndex) {
                    const between = text.substring(lastIndex, match.index).trim();
                    if (between) {
                        // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¸­à¸°à¹„à¸£
                        if (/[à¸-à¹™]/.test(between)) {
                            segments.push({ text: between, lang: 'th-TH' });
                        } else if (/[a-zA-Z]/.test(between)) {
                            segments.push({ text: between, lang: 'en-US' });
                        }
                    }
                }
                
                if (match[1]) {
                    // à¸­à¸±à¸‡à¸à¸¤à¸©
                    segments.push({ text: match[1].trim(), lang: 'en-US' });
                } else if (match[2]) {
                    // à¹„à¸—à¸¢
                    segments.push({ text: match[2].trim(), lang: 'th-TH' });
                }
                lastIndex = regex.lastIndex;
            }
            
            // à¹€à¸à¸´à¹ˆà¸¡à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­
            if (lastIndex < text.length) {
                const remaining = text.substring(lastIndex).trim();
                if (remaining) {
                    if (/[à¸-à¹™]/.test(remaining)) {
                        segments.push({ text: remaining, lang: 'th-TH' });
                    } else {
                        segments.push({ text: remaining, lang: 'en-US' });
                    }
                }
            }
            
            // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ segment à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹€à¸›à¹‡à¸™à¹„à¸—à¸¢
            if (segments.length === 0 && text.trim()) {
                segments.push({ text: text.trim(), lang: 'th-TH' });
            }
            
            // à¸£à¸§à¸¡ segment à¸—à¸µà¹ˆà¸ à¸²à¸©à¸²à¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™à¸•à¸´à¸”à¸à¸±à¸™
            const merged = [];
            for (const seg of segments) {
                if (merged.length > 0 && merged[merged.length - 1].lang === seg.lang) {
                    merged[merged.length - 1].text += ' ' + seg.text;
                } else {
                    merged.push({ ...seg });
                }
            }
            
            return merged;
        }

        function toggleSpeech() {
            if (SPEAKING) {
                SPEAKING = false;
                speechSynthesis.cancel();
                document.getElementById('speaker').className = 'speaker';
            }
        }

        // Start
        window.onload = function() {
            updateQuickBtns();
            testAPIs();
        };
    </script>
</body>
</html>
